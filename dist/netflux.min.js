!function(e,n){"object"==typeof exports&&"object"==typeof module?module.exports=n():"function"==typeof define&&define.amd?define([],n):"object"==typeof exports?exports.nf=n():e.nf=n()}(this,function(){return function(e){function n(o){if(t[o])return t[o].exports;var r=t[o]={exports:{},id:o,loaded:!1};return e[o].call(r.exports,r,r.exports,n),r.loaded=!0,r.exports}var t={};return n.m=e,n.c=t,n.p="",n(0)}([function(e,n,t){"use strict";function o(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(n[t]=e[t]);return n["default"]=e,n}function r(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(n,"__esModule",{value:!0}),n.WebChannel=n.FULLY_CONNECTED=n.WEBRTC=void 0;var i=t(1),a=r(i),c=t(2),s=o(c),u=s.WEBRTC,l=s.FULLY_CONNECTED;n.WEBRTC=u,n.FULLY_CONNECTED=l,n.WebChannel=a["default"]},function(e,n,t){"use strict";function o(e){return e&&e.__esModule?e:{"default":e}}function r(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(n[t]=e[t]);return n["default"]=e,n}function i(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var a=function(){function e(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,t,o){return t&&e(n.prototype,t),o&&e(n,o),n}}(),c=t(2),s=r(c),u=t(6),l=t(7),d=o(l),f=function(){function e(){var n=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];i(this,e),this.defaults={connector:s.WEBRTC,topology:s.FULLY_CONNECTED},this.settings=Object.assign({},this.defaults,n),this.id=this.generateId(),this.myId=this.generateId(),this.channels=new Set,this.onJoin,this.joiningPeers=new Set,this.connectWithRequests=new Map,this.connections=new Map,this.proxy=s.get(s.CHANNEL_PROXY),this.topology=this.settings.topology}return a(e,[{key:"onJoining",value:function(e){}},{key:"onLeaving",value:function(e){}},{key:"onMessage",value:function(e,n){}},{key:"leave",value:function(){this.manager.broadcast(this,this.proxy.msg(u.LEAVE,{id:this.myId}))}},{key:"send",value:function(e){this.manager.broadcast(this,this.proxy.msg(u.USER_DATA,{id:this.myId,data:e}))}},{key:"sendTo",value:function(e,n){this.manager.sendTo(e,this,this.proxy.msg(u.USER_DATA,{id:this.myId,data:n}))}},{key:"openForJoining",value:function(){var e=this,n=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],t=Object.assign({},this.settings,n),o=s.get(t.connector,t),r=this.id+this.myId;try{var i=o.open(this,r,function(n){var t=new d["default"](n.peerId,e.myId);t.intermediaryChannel=n,e.joiningPeers.add(t),console.log("send JOIN_INIT his new id: "+n.peerId),console.log("New channel: "+n.readyState),n.send(e.proxy.msg(u.JOIN_INIT,{manager:e.settings.topology,id:n.peerId,intermediaryId:e.myId})),e.manager.broadcast(e,e.proxy.msg(u.JOIN_NEW_MEMBER,{id:n.peerId,intermediaryId:e.myId})),e.manager.add(n).then(function(){n.send(e.proxy.msg(u.JOIN_FINILIZE))})["catch"](function(o){console.log("Adding peer "+n.peerId+" failed: "+o),e.manager.broadcast(e,e.proxy.msg(u.REMOVE_NEW_MEMBER,{id:n.peerId})),e.removeJoiningPeer(t.id)})});return this.webRTCOpen=i.socket,i.key}catch(a){console.log("WebChannel open error: ",a)}}},{key:"closeForJoining",value:function(){Reflect.has(this,"webRTCOpen")&&this.webRTCOpen.close()}},{key:"join",value:function(e){var n=this,t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],o=Object.assign({},this.settings,t),r=s.get(o.connector,o);return new Promise(function(t,o){r.join(n,e).then(function(e){console.log("JOIN channel established"),n.onJoin=function(){t(n)}})["catch"](function(e){return o(e)})})}},{key:"isInviting",value:function(){}},{key:"has",value:function(e){var n=!0,t=!1,o=void 0;try{for(var r,i=this.channels[Symbol.iterator]();!(n=(r=i.next()).done);n=!0){var a=r.value;if(a.peerId===e)return!0}}catch(c){t=!0,o=c}finally{try{!n&&i["return"]&&i["return"]()}finally{if(t)throw o}}return!1}},{key:"sendSrvMsg",value:function(e,n){var t=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],o={serviceName:e,recepient:n,data:Object.assign({},t)},r=this.proxy.msg(u.SERVICE_DATA,o);if(n===this.myId)this.proxy.onSrvMsg(this,o);else if(this.isJoining()){var i=this.getJoiningPeer(this.myId).intermediaryChannel;"closed"!==i.readyState&&i.send(r)}else if(this.hasJoiningPeer(n)){var a=this.getJoiningPeer(n);a.intermediaryId===this.myId&&"closed"!==a.intermediaryChannel.readyState?a.intermediaryChannel.send(r):this.manager.sendTo(a.intermediaryId,this,r)}else this.manager.sendTo(n,this,r)}},{key:"initChannel",value:function(e){var n=this,t=arguments.length<=1||void 0===arguments[1]?"":arguments[1];e.webChannel=this,e.onmessage=this.proxy.onMsg,e.onerror=this.proxy.onError,e.onclose=this.proxy.onClose,""!==t?e.peerId=t:e.peerId=this.generateId(),e.connection.oniceconnectionstatechange=function(){console.log("STATE FOR "+e.peerId+" CHANGED TO: ",e.connection.iceConnectionState),"disconnected"===e.connection.iceConnectionState&&(n.channels["delete"](e),n.onLeaving(e.peerId))}}},{key:"joinSuccess",value:function(e){var n=this,t=this.getJoiningPeer(e);t.channelsToAdd.forEach(function(e){n.channels.add(e),n.joiningPeers["delete"](t)})}},{key:"getJoiningPeer",value:function(e){var n=!0,t=!1,o=void 0;try{for(var r,i=this.joiningPeers[Symbol.iterator]();!(n=(r=i.next()).done);n=!0){var a=r.value;if(a.id===e)return a}}catch(c){t=!0,o=c}finally{try{!n&&i["return"]&&i["return"]()}finally{if(t)throw o}}throw new Error("Joining peer not found!")}},{key:"addJoiningPeer",value:function(e){if(this.hasJoiningPeer(e.id))throw new Error("Joining peer already exists!");this.joiningPeers.add(e)}},{key:"removeJoiningPeer",value:function(e){this.hasJoiningPeer(e)&&this.joiningPeers["delete"](this.getJoiningPeer(e))}},{key:"isJoining",value:function(){var e=!0,n=!1,t=void 0;try{for(var o,r=this.joiningPeers[Symbol.iterator]();!(e=(o=r.next()).done);e=!0){var i=o.value;if(i.id===this.myId)return!0}}catch(a){n=!0,t=a}finally{try{!e&&r["return"]&&r["return"]()}finally{if(n)throw t}}return!1}},{key:"hasJoiningPeer",value:function(e){var n=!0,t=!1,o=void 0;try{for(var r,i=this.joiningPeers[Symbol.iterator]();!(n=(r=i.next()).done);n=!0){var a=r.value;if(a.id===e)return!0}}catch(c){t=!0,o=c}finally{try{!n&&i["return"]&&i["return"]()}finally{if(t)throw o}}return!1}},{key:"generateId",value:function(){for(var e=2,n=0,t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",o="",r=e+Math.round(Math.random()*n),i=0;r>i;i++)o+=t[Math.round(Math.random()*(t.length-1))];return o}},{key:"topology",set:function(e){this.settings.topology=e,this.manager=s.get(this.settings.topology)},get:function(){return this.settings.topology}}]),e}();n["default"]=f},function(e,n,t){"use strict";function o(e){return e&&e.__esModule?e:{"default":e}}function r(e){var n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];if(h.has(e))return h.get(e);var t=void 0;switch(e){case d:return new s["default"](n);case f:return t=new a["default"],h.set(e,t),t;case l:return t=new u.ChannelProxyService,h.set(e,t),t;default:return null}}Object.defineProperty(n,"__esModule",{value:!0}),n.FULLY_CONNECTED=n.WEBRTC=n.CHANNEL_PROXY=void 0,n.get=r;var i=t(3),a=o(i),c=t(8),s=o(c),u=t(6),l=n.CHANNEL_PROXY="ChannelProxyService",d=n.WEBRTC="WebRTCService",f=n.FULLY_CONNECTED="FullyConnectedService",h=new Map},function(e,n,t){"use strict";function o(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(n[t]=e[t]);return n["default"]=e,n}function r(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function i(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n}function a(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}Object.defineProperty(n,"__esModule",{value:!0});var c=function(){function e(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,t,o){return t&&e(n.prototype,t),o&&e(n,o),n}}(),s=t(4),u=o(s),l=function(e){function n(){return r(this,n),i(this,Object.getPrototypeOf(n).apply(this,arguments))}return a(n,e),c(n,[{key:"add",value:function(e){var n=e.webChannel,t=[n.myId];return n.channels.forEach(function(e){t[t.length]=e.peerId}),n.joiningPeers.forEach(function(n){e.peerId!==n.id&&(t[t.length]=n.id)}),this.connectWith(n,e.peerId,e.peerId,t)}},{key:"broadcast",value:function(e,n){var t=!0,o=!1,r=void 0;try{for(var i,a=e.channels[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var c=i.value;"closed"!==c.readyState&&c.send(n)}}catch(s){o=!0,r=s}finally{try{!t&&a["return"]&&a["return"]()}finally{if(o)throw r}}}},{key:"sendTo",value:function(e,n,t){var o=!0,r=!1,i=void 0;try{for(var a,c=n.channels[Symbol.iterator]();!(o=(a=c.next()).done);o=!0){var s=a.value;if(s.peerId===e)return void("closed"!==s.readyState&&s.send(t))}}catch(u){r=!0,i=u}finally{try{!o&&c["return"]&&c["return"]()}finally{if(r)throw i}}}},{key:"leave",value:function(e){}}]),n}(u.Interface);n["default"]=l},function(e,n,t){"use strict";function o(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(n[t]=e[t]);return n["default"]=e,n}function r(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function i(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n}function a(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}Object.defineProperty(n,"__esModule",{value:!0}),n.Interface=void 0;var c=function(){function e(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,t,o){return t&&e(n.prototype,t),o&&e(n,o),n}}(),s=t(5),u=o(s),l=t(2),d=o(l),f=t(6),h=1,y=2,g=5e3,p=4,v=function(e){function n(){return r(this,n),i(this,Object.getPrototypeOf(n).apply(this,arguments))}return a(n,e),c(n,[{key:"onMessage",value:function(e,n){var t=this,o=d.get(e.settings.connector,e.settings);switch(n.code){case h:console.log("CONNECT_WITH received: ",n),n.peers=this.reUseIntermediaryChannelIfPossible(e,n.jpId,n.peers),o.connectMeToMany(e,n.peers).then(function(o){console.log("CONNECT_WITH result: ",o),o.channels.forEach(function(t){e.initChannel(t,t.peerId),e.getJoiningPeer(n.jpId).toAddList(t),t.send(e.proxy.msg(f.THIS_CHANNEL_TO_JOINING_PEER,{id:n.jpId,toBeAdded:!0}))}),console.log("CONNECT_WITH send feedback: ",{code:y,id:e.myId,failed:o.failed}),e.sendSrvMsg(t.name,n.sender,{code:y,id:e.myId,failed:o.failed})})["catch"](function(e){console.log("connectMeToMany FAILED, ",e)});break;case y:console.log("CONNECT_WITH_FEEDBACK received: ",n),e.connectWithRequests.get(n.id)(!0);break;case p:var r=e.getJoiningPeer(n.jpId);r.toAddList(r.intermediaryChannel)}}},{key:"connectWith",value:function(e,n,t,o){var r=this;return console.log("send CONNECT_WITH to: "+n+" JoiningPeerID: "+t+" with peers",o),e.sendSrvMsg(this.name,n,{code:h,jpId:t,sender:e.myId,peers:o}),new Promise(function(t,i){e.connectWithRequests.set(n,function(e){e?t():i()}),setTimeout(function(){i("CONNECT_WITH_TIMEOUT")},r.calculateConnectWithTimeout(o.length))})}},{key:"calculateConnectWithTimeout",value:function(e){return e>0?g+Math.log10(e):g}},{key:"reUseIntermediaryChannelIfPossible",value:function(e,n,t){var o=null,r=void 0;return e.isJoining()?(r=e.getJoiningPeer(n),-1!==t.indexOf(r.intermediaryId)&&(o=r.intermediaryId)):-1!==t.indexOf(n)&&(r=e.getJoiningPeer(n),null!==r.intermediaryChannel&&(o=n)),null!==o&&(r.toAddList(r.intermediaryChannel),e.sendSrvMsg(this.name,o,{code:p,jpId:n}),t.splice(t.indexOf(o),1)),t}},{key:"add",value:function(e){throw new Error("Must be implemented by subclass!")}},{key:"broadcast",value:function(e,n){throw new Error("Must be implemented by subclass!")}},{key:"sendTo",value:function(e,n,t){throw new Error("Must be implemented by subclass!")}},{key:"leave",value:function(e){throw new Error("Must be implemented by subclass!")}}]),n}(u.Interface);n.Interface=v},function(e,n){"use strict";function t(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var o=function(){function e(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,t,o){return t&&e(n.prototype,t),o&&e(n,o),n}}(),r=function(){function e(){t(this,e)}return o(e,[{key:"onMessage",value:function(e,n){throw new Error("Must be implemented by subclass!")}},{key:"name",get:function(){return this.constructor.name}}]),e}();n.Interface=r},function(e,n,t){"use strict";function o(e){return e&&e.__esModule?e:{"default":e}}function r(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(n[t]=e[t]);return n["default"]=e,n}function i(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function a(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n}function c(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}Object.defineProperty(n,"__esModule",{value:!0}),n.ChannelProxyService=n.THIS_CHANNEL_TO_JOINING_PEER=n.JOIN_SUCCESS=n.JOIN_FINILIZE=n.REMOVE_NEW_MEMBER=n.JOIN_NEW_MEMBER=n.JOIN_INIT=n.LEAVE=n.SERVICE_DATA=n.USER_DATA=void 0;var s=function(){function e(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,t,o){return t&&e(n.prototype,t),o&&e(n,o),n}}(),u=t(5),l=r(u),d=t(2),f=r(d),h=t(7),y=o(h),g=n.USER_DATA=0,p=n.SERVICE_DATA=1,v=n.LEAVE=8,b=n.JOIN_INIT=3,m=n.JOIN_NEW_MEMBER=6,w=n.REMOVE_NEW_MEMBER=9,E=n.JOIN_FINILIZE=5,C=n.JOIN_SUCCESS=4,I=n.THIS_CHANNEL_TO_JOINING_PEER=7,O=function(e){function n(){return i(this,n),a(this,Object.getPrototypeOf(n).apply(this,arguments))}return c(n,e),s(n,[{key:"onMsg",value:function(e){var n=JSON.parse(e.data),t=e.currentTarget,o=t.webChannel,r=void 0;switch(n.code){case g:o.onMessage(n.id,n.data);break;case v:o.onLeaving(n.id);var i=!0,a=!1,c=void 0;try{for(var s,u=o.channels[Symbol.iterator]();!(i=(s=u.next()).done);i=!0){var l=s.value;l.peerId===n.id&&o.channels["delete"](l)}}catch(d){a=!0,c=d}finally{try{!i&&u["return"]&&u["return"]()}finally{if(a)throw c}}break;case p:o.myId===n.recepient?o.proxy.onSrvMsg(o,n):o.sendSrvMsg(n.serviceName,n.recepient,n.data);break;case b:console.log("JOIN_INIT my new id: "+n.id),o.topology=n.manager,o.myId=n.id,t.peerId=n.intermediaryId,r=new y["default"](n.id,n.intermediaryId),r.intermediaryChannel=t,o.addJoiningPeer(r);break;case m:o.addJoiningPeer(new y["default"](n.id,n.intermediaryId));break;case w:o.removeJoiningPeer(n.id);break;case E:o.joinSuccess(o.myId);var f=o.proxy.msg(C,{id:o.myId});o.manager.broadcast(o,f),o.onJoin();break;case C:o.joinSuccess(n.id),o.onJoining(n.id);break;case I:o.hasJoiningPeer(n.id)?r=o.getJoiningPeer(n.id):(r=new y["default"](n.id),o.addJoiningPeer(r)),n.toBeAdded?r.toAddList(t):r.toRemoveList(t)}}},{key:"onClose",value:function(e){console.log("DATA_CHANNEL CLOSE: ",e)}},{key:"onError",value:function(e){console.log("DATA_CHANNEL ERROR: ",e)}},{key:"onSrvMsg",value:function(e,n){f.get(n.serviceName,e.settings).onMessage(e,n.data)}},{key:"msg",value:function t(e){var n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],t=Object.assign({code:e},n);return JSON.stringify(t)}}]),n}(l.Interface);n.ChannelProxyService=O},function(e,n){"use strict";function t(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var o=function(){function e(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,t,o){return t&&e(n.prototype,t),o&&e(n,o),n}}(),r=function(){function e(n,o){t(this,e),this.id=n,this.intermediaryId=o,this.intermediaryChannel=null,this.channelsToAdd=[],this.channelsToRemove=[]}return o(e,[{key:"toAddList",value:function(e){this.channelsToAdd[this.channelsToAdd.length]=e}},{key:"toRemoveList",value:function(e){this.channelsToAdd[this.channelsToAdd.length]=e}}]),e}();n["default"]=r},function(e,n,t){"use strict";function o(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(n[t]=e[t]);return n["default"]=e,n}function r(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function i(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n}function a(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}Object.defineProperty(n,"__esModule",{value:!0});var c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},s=function(){function e(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,t,o){return t&&e(n.prototype,t),o&&e(n,o),n}}(),u=t(2),l=(o(u),t(9)),d=o(l),f=2e3,h=function(e){function n(e){var t=arguments.length<=1||void 0===arguments[1]?null:arguments[1];r(this,n);var o=i(this,Object.getPrototypeOf(n).call(this,e));return o.name="SignalingError",o.evt=t,o}return a(n,e),n}(Error),y=function(e){function n(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];r(this,n);var t=i(this,Object.getPrototypeOf(n).call(this));return t.defaults={signaling:"wws://sigver-coastteam.rhcloud.com:8000",iceServers:[{urls:"stun:23.21.150.121"},{urls:"stun:stun.l.google.com:19302"},{urls:"turn:numb.viagenie.ca",credential:"webrtcdemo",username:"louis%40mozilla.com"}]},t.settings=Object.assign({},t.defaults,e),t.RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,t.RTCIceCandidate=window.RTCIceCandidate||window.mozRTCIceCandidate||window.RTCIceCandidate,t.RTCSessionDescription=window.RTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription,t}return a(n,e),s(n,[{key:"open",value:function(e,n,t){var o=this,r=arguments.length<=3||void 0===arguments[3]?{}:arguments[3],i=Object.assign({},this.settings,r),a=[];try{var s=function(){var r=new window.WebSocket(i.signaling);return r.onopen=function(){r.send(o.toStr({key:n}))},r.onmessage=function(n){var i=JSON.parse(n.data);if(console.log("NETFLUX: message: ",i),!Reflect.has(i,"id")||!Reflect.has(i,"data"))throw new Error("Incorrect message format from the signaling server.");Reflect.has(i.data,"offer")?a[a.length]=o.createConnectionAndAnswer(function(e){return r.send(o.toStr({id:i.id,data:{candidate:e}}))},function(e){return r.send(o.toStr({id:i.id,data:{answer:e}}))},t,i.data.offer,e):Reflect.has(i.data,"candidate")&&(console.log("NETFLUX adding candidate"),a[i.id].addIceCandidate(o.createCandidate(i.data.candidate),function(){},function(e){console.log("NETFLUX adding candidate failed: ",e)}))},r.onerror=function(e){throw new h("error occured on the socket with signaling server "+i.signaling)},r.onclose=function(e){if(1e3!==e.code)throw new h("connection with signaling server\n            "+i.signaling+" has been closed abnormally.\n            CloseEvent code: "+e.code+". Reason: "+e.reason)},{v:{key:n,socket:r,signaling:i.signaling}}}();if("object"===("undefined"==typeof s?"undefined":c(s)))return s.v}catch(u){throw new h(u.name+": "+u.message)}}},{key:"join",value:function(e,n){var t=this,o=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],r=Object.assign({},this.settings,o);return console.log("NETFLUX: joining: "+n),new Promise(function(o,i){var a=void 0,c=new window.WebSocket(r.signaling);c.onopen=function(){console.log("NETFLUX: connection with Sigver has been established"),a=t.createConnectionAndOffer(function(e){return c.send(t.toStr({data:{candidate:e}}))},function(e){return c.send(t.toStr({join:n,data:{offer:e}}))},function(e){console.log("NETFLUX: channel created"),o(e)},n,e)},c.onmessage=function(e){var n=JSON.parse(e.data);if(console.log("NETFLUX: message: ",n),Reflect.has(n,"data")||i(),Reflect.has(n.data,"answer")){var o=t.createSDP(n.data.answer);console.log("NETFLUX adding answer"),a.setRemoteDescription(o,function(){},function(e){console.log("NETFLUX adding answer failed: ",e),i()})}else Reflect.has(n.data,"candidate")?(console.log("NETFLUX adding candidate"),a.addIceCandidate(t.createCandidate(n.data.candidate),function(){},function(e){console.log("NETFLUX adding candidate failed: ",e)})):i()},c.onerror=function(e){i("Signaling server socket error: "+e.message)},c.onclose=function(e){console.log("Closing server: ",e),1e3!==e.code&&i(e.reason)}})}},{key:"connectMeToMany",value:function(e,n){var t=this;return new Promise(function(o,r){var i=0,a={channels:[],failed:[]};if(0===n.length)o(a);else{var c=!0,s=!1,u=void 0;try{for(var l,d=function(){var r=l.value;t.connectMeToOne(e,r).then(function(e){i++,a.channels.push(e),i===n.length&&o(a)})["catch"](function(e){i++,a.failed.push({id:r,err:e}),i===n.length&&o(a)})},f=n[Symbol.iterator]();!(c=(l=f.next()).done);c=!0)d()}catch(h){s=!0,u=h}finally{try{!c&&f["return"]&&f["return"]()}finally{if(s)throw u}}}})}},{key:"connectMeToOne",value:function(e,n){var t=this;return new Promise(function(o,r){var i=e.myId,a=t.createConnectionAndOffer(function(o){return e.sendSrvMsg(t.name,n,{sender:i,candidate:o})},function(o){e.connections.set(n,a),e.sendSrvMsg(t.name,n,{sender:i,offer:o})},function(e){return o(e)},n,e,n);setTimeout(r,f,"Timeout")})}},{key:"onMessage",value:function(e,n){var t=this,o=e.connections;if(Reflect.has(n,"offer"))o.set(n.sender,this.createConnectionAndAnswer(function(o){return e.sendSrvMsg(t.name,n.sender,{sender:e.myId,candidate:o})},function(o){return e.sendSrvMsg(t.name,n.sender,{sender:e.myId,answer:o})},function(n){e.connections["delete"](n.peerId)},n.offer,e,n.sender)),console.log(n.sender+" create a NEW CONNECTION");else if(o.has(n.sender)){var r=o.get(n.sender);if(Reflect.has(n,"answer")){var i=this.createSDP(n.answer);r.setRemoteDescription(i,function(){},function(){})}else Reflect.has(n,"candidate")&&r&&r.addIceCandidate(this.createCandidate(n.candidate))}}},{key:"createConnectionAndOffer",value:function(e,n,t,o,r){var i=arguments.length<=5||void 0===arguments[5]?"":arguments[5],a=this.initConnection(e),c=a.createDataChannel(o);return console.log("NETFLUX: dataChannel created"),c.onopen=function(){console.log("NETFLUX: Channel opened"),c.send("ping"),console.log("SEND PING")},window.dc=c,c.onmessage=function(e){"pong"===e.data&&(console.log("PONG Received"),c.connection=a,r.initChannel(c,i),t(c))},c.onerror=function(e){console.log("NETFLUX: channel error: ",e)},a.createOffer(function(e){a.setLocalDescription(e,function(){n(a.localDescription.toJSON())},function(e){throw console.log("NETFLUX: error 1: ",e),new Error("Could not set local description: "+e)})},function(e){throw console.log("NETFLUX: error 2: ",e),new Error("Could not create offer: "+e)}),a}},{key:"createConnectionAndAnswer",value:function(e,n,t,o,r){var i=arguments.length<=5||void 0===arguments[5]?"":arguments[5],a=this.initConnection(e);return a.ondatachannel=function(e){e.channel.onmessage=function(n){"ping"===n.data&&(console.log("PING Received, send PONG"),e.channel.connection=a,r.initChannel(e.channel,i),e.channel.send("pong"),t(e.channel))},e.channel.onopen=function(){console.log("NETFLUX: Channel opened")}},console.log("NETFLUX adding offer"),a.setRemoteDescription(this.createSDP(o),function(){a.createAnswer(function(e){a.setLocalDescription(e,function(){n(a.localDescription.toJSON())},function(e){throw console.log("NETFLUX: error: ",e),new Error("Could not set local description: "+e)})},function(e){throw console.log("NETFLUX: error: ",e),new Error("Could not create answer: "+e)})},function(e){throw console.log("NETFLUX: error: ",e),new Error("Could not set remote description: "+e)}),a}},{key:"initConnection",value:function(e){var n=new this.RTCPeerConnection({iceServers:this.settings.iceServers});return n.onicecandidate=function(n){if(null!==n.candidate){var t={candidate:n.candidate.candidate,sdpMLineIndex:n.candidate.sdpMLineIndex};e(t)}},n}},{key:"createCandidate",value:function(e){return new this.RTCIceCandidate(e)}},{key:"createSDP",value:function(e){return Object.assign(new this.RTCSessionDescription,e)}},{key:"randomKey",value:function(){for(var e=10,n=10,t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",o="",r=e+Math.round(Math.random()*n),i=0;r>i;i++)o+=t[Math.round(Math.random()*(t.length-1))];return o}},{key:"toStr",value:function(e){return JSON.stringify(e)}}]),n}(d.Interface);n["default"]=y},function(e,n,t){"use strict";function o(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(n[t]=e[t]);return n["default"]=e,n}function r(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function i(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n}function a(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}Object.defineProperty(n,"__esModule",{value:!0}),n.Interface=void 0;var c=function(){function e(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,t,o){return t&&e(n.prototype,t),o&&e(n,o),n}}(),s=t(5),u=o(s),l=function(e){function n(){return r(this,n),i(this,Object.getPrototypeOf(n).apply(this,arguments))}return a(n,e),c(n,[{key:"connectMeToMany",value:function(e,n){throw new Error("Must be implemented by subclass!")}},{key:"connectMeToOne",value:function(e,n){throw new Error("Must be implemented by subclass!")}},{key:"open",value:function(e,n){throw new Error("Must be implemented by subclass!")}},{key:"join",value:function(e,n){throw new Error("Must be implemented by subclass!")}}]),n}(u.Interface);n.Interface=l}])});