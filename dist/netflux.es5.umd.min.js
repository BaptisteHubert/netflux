!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.netflux=e.netflux||{})}(this,function(e){"use strict";function t(e){var t={connector:pe,topology:me,signalingURL:"wss://sigver-coastteam.rhcloud.com:8443",iceServers:[{urls:"stun:turn01.uswest.xirsys.com"}],listenOn:""},n=Object.assign({},t,e);return new K(n)}var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},r=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),o=function e(t,n,i){null===t&&(t=Function.prototype);var r=Object.getOwnPropertyDescriptor(t,n);if(void 0===r){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,n,i)}if("value"in r)return r.value;var a=r.get;if(void 0!==a)return a.call(i)},a=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},s=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},c=function e(t,n,i,r){var o=Object.getOwnPropertyDescriptor(t,n);if(void 0===o){var a=Object.getPrototypeOf(t);null!==a&&e(a,n,i,r)}else if("value"in o&&o.writable)o.value=i;else{var s=o.set;void 0!==s&&s.call(r,i)}return i},u=6e4,d=new Map,l=new Map,h=function(){function e(t){i(this,e),this.id=t,d.has(this.id)||d.set(this.id,new WeakMap),l.has(this.id)||l.set(this.id,new WeakMap)}return r(e,[{key:"setPendingRequest",value:function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:u;this.setTo(l,e,t,n),setTimeout(function(){n.reject("Pending request timeout")},i)}},{key:"getPendingRequest",value:function(e,t){return this.getFrom(l,e,t)}},{key:"setItem",value:function(e,t,n){this.setTo(d,e,t,n)}},{key:"getItem",value:function(e,t){return this.getFrom(d,e,t)}},{key:"getItems",value:function(e){var t=d.get(this.id).get(e);return t?t:new Map}},{key:"removeItem",value:function(e,t){var n=d.get(this.id),i=n.get(e);n.get(e).delete(t),0===i.size&&n.delete(e)}},{key:"getFrom",value:function(e,t,n){var i=e.get(this.id).get(t);if(void 0!==i){var r=i.get(n);if(void 0!==r)return r}return null}},{key:"setTo",value:function(e,t,n,i){var r=e.get(this.id),o=void 0;r.has(t)?o=r.get(t):(o=new Map,r.set(t,o)),o.has(n)||o.set(n,i)}}]),e}(),f=function(e){function t(){return i(this,t),s(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return a(t,e),r(t,[{key:"connectTo",value:function(e,t){var n=this,i=[];return 0===t.length?Promise.resolve(i):new Promise(function(r,o){var a=0,s=Oe.get(ye);t.forEach(function(o){s.connectTo(e,o).then(function(e){return n.onChannel(e)}).then(function(){++a===t.length&&r(i)}).catch(function(e){i.push({id:o,reason:e}),++a===t.length&&r(i)})})})}},{key:"add",value:function(e){throw new Error("Must be implemented by subclass!")}},{key:"broadcast",value:function(e,t){throw new Error("Must be implemented by subclass!")}},{key:"sendTo",value:function(e,t,n){throw new Error("Must be implemented by subclass!")}},{key:"leave",value:function(e){throw new Error("Must be implemented by subclass!")}}]),t}(h),p=1,v=2,g=3,y=4,m=5,w=function(e){function t(){return i(this,t),s(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return a(t,e),r(t,[{key:"add",value:function(e){var n=this,i=e.webChannel,r=i.members.slice(),a=!0,s=!1,c=void 0;try{for(var u,d=o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"getItems",this).call(this,i).keys()[Symbol.iterator]();!(a=(u=d.next()).done);a=!0){var l=u.value;r[r.length]=l}}catch(e){s=!0,c=e}finally{try{!a&&d.return&&d.return()}finally{if(s)throw c}}return this.setJP(i,e.peerId,e),i.sendInner(this.id,{code:p,jpId:e.peerId}),i.sendInnerTo(e,this.id,{code:v,peers:r}),new Promise(function(r,a){o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"setPendingRequest",n).call(n,i,e.peerId,{resolve:r,reject:a})})}},{key:"broadcast",value:function(e,t){var n=!0,i=!1,r=void 0;try{for(var o,a=e.channels[Symbol.iterator]();!(n=(o=a.next()).done);n=!0){var s=o.value;s.send(t)}}catch(e){i=!0,r=e}finally{try{!n&&a.return&&a.return()}finally{if(i)throw r}}}},{key:"sendTo",value:function(e,t,n){var i=!0,r=!1,o=void 0;try{for(var a,s=t.channels[Symbol.iterator]();!(i=(a=s.next()).done);i=!0){var c=a.value;if(c.peerId===e)return void c.send(n)}}catch(e){r=!0,o=e}finally{try{!i&&s.return&&s.return()}finally{if(r)throw o}}}},{key:"sendInnerTo",value:function(e,n,i){if(e===n.myId)n.onChannelMessage(null,i);else{var r=o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"getItem",this).call(this,n,n.myId);null===r&&(r=o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"getItem",this).call(this,n,e)),null!==r?r.channel.send(i):n.members.includes(e)?this.sendTo(e,n,i):this.sendTo(n.members[0],n,i)}}},{key:"sendInner",value:function(e,n){var i=o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"getItem",this).call(this,e,e.myId);null===i?this.broadcast(e,n):i.channel.send(n)}},{key:"leave",value:function(e){var t=!0,n=!1,i=void 0;try{for(var r,o=e.channels[Symbol.iterator]();!(t=(r=o.next()).done);t=!0){var a=r.value;a.clearHandlers(),a.close()}}catch(e){n=!0,i=e}finally{try{!t&&o.return&&o.return()}finally{if(n)throw i}}e.channels.clear()}},{key:"onChannel",value:function(e){var n=this;return new Promise(function(i,r){o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"setPendingRequest",n).call(n,e.webChannel,e.peerId,{resolve:i,reject:r}),e.webChannel.sendInnerTo(e,n.id,{code:y})})}},{key:"onChannelClose",value:function(e,n){var i=n.webChannel,r=!0,a=!1,s=void 0;try{for(var c,u=i.channels[Symbol.iterator]();!(r=(c=u.next()).done);r=!0){var d=c.value;if(d.peerId===n.peerId)return i.channels.delete(d)}}catch(e){a=!0,s=e}finally{try{!r&&u.return&&u.return()}finally{if(a)throw s}}var l=o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"getItems",this).call(this,i);return l.forEach(function(e){return e.channels.delete(n)}),!1}},{key:"onChannelError",value:function(e,t){console.error("Channel error with id: "+t.peerId+": ",e)}},{key:"onMessage",value:function(e,n,i,r){var a=this,s=e.webChannel,c=void 0;switch(r.code){case v:c=this.setJP(s,s.myId,e),c.channels.add(e),o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"connectTo",this).call(this,s,r.peers).then(function(e){var n={code:g};c.channels.forEach(function(e){s.sendInnerTo(e,a.id,n),s.channels.add(e),s.onPeerJoin$(e.peerId)}),o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"removeItem",a).call(a,s,s.myId),o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"getItems",a).call(a,s).forEach(function(e){return s.sendInnerTo(e.channel,a.id,n)}),s.onJoin()});break;case g:if(c=o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"getItem",this).call(this,s,s.myId),o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"removeItem",this).call(this,s,n),null!==c)c.channels.add(e);else{s.channels.add(e),s.onPeerJoin$(n);var u=o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"getPendingRequest",this).call(this,s,n);null!==u&&u.resolve(n)}break;case y:this.setJP(s,n,e);var d=null!==o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"getItem",this).call(this,s,s.myId);s.sendInnerTo(e,this.id,{code:m,isJoining:d});break;case m:r.isJoining?this.setJP(s,n,e):o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"getItem",this).call(this,s,s.myId).channels.add(e),o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"getPendingRequest",this).call(this,s,n).resolve();break;case p:this.setJP(s,r.jpId,e)}}},{key:"setJP",value:function(e,n,i){var r=o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"getItem",this).call(this,e,n);return r?r.channel=i:(r=new b(i),o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"setItem",this).call(this,e,n,r)),r}}]),t}(f),b=function e(t,n){i(this,e),this.channel=t,this.channels=new Set};!function e(t,n,i){function r(a,s){if(!n[a]){if(!t[a]){var c="function"==typeof require&&require;if(!s&&c)return c(a,!0);if(o)return o(a,!0);var u=new Error("Cannot find module '"+a+"'");throw u.code="MODULE_NOT_FOUND",u}var d=n[a]={exports:{}};t[a][0].call(d.exports,function(e){var n=t[a][1][e];return r(n?n:e)},d,d.exports,e,t,n,i)}return n[a].exports}for(var o="function"==typeof require&&require,a=0;a<i.length;a++)r(i[a]);return r}({1:[function(e,t,n){},{}],2:[function(e,t,n){!function(){var n=e("./utils"),i=n.log,r=n.browserDetails;t.exports.browserDetails=r,t.exports.extractVersion=n.extractVersion,t.exports.disableLog=n.disableLog;var o=e("./chrome/chrome_shim")||null,a=e("./edge/edge_shim")||null,s=e("./firefox/firefox_shim")||null,c=e("./safari/safari_shim")||null;switch(r.browser){case"opera":case"chrome":if(!o||!o.shimPeerConnection)return void i("Chrome shim is not included in this adapter release.");i("adapter.js shimming chrome."),t.exports.browserShim=o,o.shimGetUserMedia(),o.shimMediaStream(),o.shimSourceObject(),n.shimCreateObjectURL(),o.shimPeerConnection(),o.shimOnTrack();break;case"firefox":if(!s||!s.shimPeerConnection)return void i("Firefox shim is not included in this adapter release.");i("adapter.js shimming firefox."),t.exports.browserShim=s,s.shimGetUserMedia(),n.shimCreateObjectURL(),s.shimSourceObject(),s.shimPeerConnection(),s.shimOnTrack();break;case"edge":if(!a||!a.shimPeerConnection)return void i("MS edge shim is not included in this adapter release.");i("adapter.js shimming edge."),t.exports.browserShim=a,a.shimGetUserMedia(),n.shimCreateObjectURL(),a.shimPeerConnection();break;case"safari":if(!c)return void i("Safari shim is not included in this adapter release.");i("adapter.js shimming safari."),t.exports.browserShim=c,c.shimGetUserMedia();break;default:i("Unsupported browser!")}}()},{"./chrome/chrome_shim":3,"./edge/edge_shim":1,"./firefox/firefox_shim":5,"./safari/safari_shim":7,"./utils":8}],3:[function(e,t,i){var r=e("../utils.js").log,o=e("../utils.js").browserDetails,a={shimMediaStream:function(){window.MediaStream=window.MediaStream||window.webkitMediaStream},shimOnTrack:function(){"object"!=("undefined"==typeof window?"undefined":n(window))||!window.RTCPeerConnection||"ontrack"in window.RTCPeerConnection.prototype||Object.defineProperty(window.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){var t=this;this._ontrack&&(this.removeEventListener("track",this._ontrack),this.removeEventListener("addstream",this._ontrackpoly)),this.addEventListener("track",this._ontrack=e),this.addEventListener("addstream",this._ontrackpoly=function(e){e.stream.addEventListener("addtrack",function(n){var i=new Event("track");i.track=n.track,i.receiver={track:n.track},i.streams=[e.stream],t.dispatchEvent(i)}),e.stream.getTracks().forEach(function(t){var n=new Event("track");n.track=t,n.receiver={track:t},n.streams=[e.stream],this.dispatchEvent(n)}.bind(this))}.bind(this))}})},shimSourceObject:function(){"object"==("undefined"==typeof window?"undefined":n(window))&&(!window.HTMLMediaElement||"srcObject"in window.HTMLMediaElement.prototype||Object.defineProperty(window.HTMLMediaElement.prototype,"srcObject",{get:function(){return this._srcObject},set:function(e){var t=this;return this._srcObject=e,this.src&&URL.revokeObjectURL(this.src),e?(this.src=URL.createObjectURL(e),e.addEventListener("addtrack",function(){t.src&&URL.revokeObjectURL(t.src),t.src=URL.createObjectURL(e)}),void e.addEventListener("removetrack",function(){t.src&&URL.revokeObjectURL(t.src),t.src=URL.createObjectURL(e)})):void(this.src="")}}))},shimPeerConnection:function(){window.RTCPeerConnection||(window.RTCPeerConnection=function(e,t){return r("PeerConnection"),e&&e.iceTransportPolicy&&(e.iceTransports=e.iceTransportPolicy),new webkitRTCPeerConnection(e,t)},window.RTCPeerConnection.prototype=webkitRTCPeerConnection.prototype,webkitRTCPeerConnection.generateCertificate&&Object.defineProperty(window.RTCPeerConnection,"generateCertificate",{get:function(){return webkitRTCPeerConnection.generateCertificate}}));var e=RTCPeerConnection.prototype.getStats;RTCPeerConnection.prototype.getStats=function(t,n,i){var r=this,o=arguments;if(arguments.length>0&&"function"==typeof t)return e.apply(this,arguments);if(0===e.length)return e.apply(this,arguments);var a=function(e){var t={},n=e.result();return n.forEach(function(e){var n={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach(function(t){n[t]=e.stat(t)}),t[n.id]=n}),t},s=function(e){return new Map(Object.keys(e).map(function(t){return[t,e[t]]}))};if(arguments.length>=2){var c=function(e){o[1](s(a(e)))};return e.apply(this,[c,arguments[0]])}return new Promise(function(t,n){e.apply(r,[function(e){t(s(a(e)))},n])}).then(n,i)},o.version<51&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(e){var t=RTCPeerConnection.prototype[e];RTCPeerConnection.prototype[e]=function(){var e=arguments,n=this,i=new Promise(function(i,r){t.apply(n,[e[0],i,r])});return e.length<2?i:i.then(function(){e[1].apply(null,[])},function(t){e.length>=3&&e[2].apply(null,[t])})}}),o.version<52&&["createOffer","createAnswer"].forEach(function(e){var t=RTCPeerConnection.prototype[e];RTCPeerConnection.prototype[e]=function(){var e=this;if(arguments.length<1||1===arguments.length&&"object"==n(arguments[0])){var i=1===arguments.length?arguments[0]:void 0;return new Promise(function(n,r){t.apply(e,[n,r,i])})}return t.apply(this,arguments)}}),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(e){var t=RTCPeerConnection.prototype[e];RTCPeerConnection.prototype[e]=function(){return arguments[0]=new("addIceCandidate"===e?RTCIceCandidate:RTCSessionDescription)(arguments[0]),t.apply(this,arguments)}});var t=RTCPeerConnection.prototype.addIceCandidate;RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?t.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}};t.exports={shimMediaStream:a.shimMediaStream,shimOnTrack:a.shimOnTrack,shimSourceObject:a.shimSourceObject,shimPeerConnection:a.shimPeerConnection,shimGetUserMedia:e("./getusermedia")}},{"../utils.js":8,"./getusermedia":4}],4:[function(e,t,i){var r=e("../utils.js").log;t.exports=function(){var e=function(e){if("object"!=("undefined"==typeof e?"undefined":n(e))||e.mandatory||e.optional)return e;var t={};return Object.keys(e).forEach(function(i){if("require"!==i&&"advanced"!==i&&"mediaSource"!==i){var r="object"==n(e[i])?e[i]:{ideal:e[i]};void 0!==r.exact&&"number"==typeof r.exact&&(r.min=r.max=r.exact);var o=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==r.ideal){t.optional=t.optional||[];var a={};"number"==typeof r.ideal?(a[o("min",i)]=r.ideal,t.optional.push(a),a={},a[o("max",i)]=r.ideal,t.optional.push(a)):(a[o("",i)]=r.ideal,t.optional.push(a))}void 0!==r.exact&&"number"!=typeof r.exact?(t.mandatory=t.mandatory||{},t.mandatory[o("",i)]=r.exact):["min","max"].forEach(function(e){void 0!==r[e]&&(t.mandatory=t.mandatory||{},t.mandatory[o(e,i)]=r[e])})}}),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},t=function(t,i){if(t=JSON.parse(JSON.stringify(t)),t&&t.audio&&(t.audio=e(t.audio)),t&&"object"==n(t.video)){var o=t.video.facingMode;if(o=o&&("object"==("undefined"==typeof o?"undefined":n(o))?o:{ideal:o}),o&&("user"===o.exact||"environment"===o.exact||"user"===o.ideal||"environment"===o.ideal)&&(!navigator.mediaDevices.getSupportedConstraints||!navigator.mediaDevices.getSupportedConstraints().facingMode)&&(delete t.video.facingMode,"environment"===o.exact||"environment"===o.ideal))return navigator.mediaDevices.enumerateDevices().then(function(n){n=n.filter(function(e){return"videoinput"===e.kind});var a=n.find(function(e){return e.label.toLowerCase().indexOf("back")!==-1})||n.length&&n[n.length-1];return a&&(t.video.deviceId=o.exact?{exact:a.deviceId}:{ideal:a.deviceId}),t.video=e(t.video),r("chrome: "+JSON.stringify(t)),i(t)});t.video=e(t.video)}return r("chrome: "+JSON.stringify(t)),i(t)},i=function(e){return{name:{PermissionDeniedError:"NotAllowedError",ConstraintNotSatisfiedError:"OverconstrainedError"}[e.name]||e.name,message:e.message,constraint:e.constraintName,toString:function(){return this.name+(this.message&&": ")+this.message}}},o=function(e,n,r){t(e,function(e){navigator.webkitGetUserMedia(e,n,function(e){r(i(e))})})};navigator.getUserMedia=o;var a=function(e){return new Promise(function(t,n){navigator.getUserMedia(e,t,n)})};if(navigator.mediaDevices||(navigator.mediaDevices={getUserMedia:a,enumerateDevices:function(){return new Promise(function(e){var t={audio:"audioinput",video:"videoinput"};return MediaStreamTrack.getSources(function(n){e(n.map(function(e){return{label:e.label,kind:t[e.kind],deviceId:e.id,groupId:""}}))})})}}),navigator.mediaDevices.getUserMedia){var s=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(e){return t(e,function(e){return s(e).then(function(t){if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length)throw t.getTracks().forEach(function(e){e.stop()}),new DOMException("","NotFoundError");return t},function(e){return Promise.reject(i(e))})})}}else navigator.mediaDevices.getUserMedia=function(e){return a(e)};"undefined"==typeof navigator.mediaDevices.addEventListener&&(navigator.mediaDevices.addEventListener=function(){r("Dummy mediaDevices.addEventListener called.")}),"undefined"==typeof navigator.mediaDevices.removeEventListener&&(navigator.mediaDevices.removeEventListener=function(){r("Dummy mediaDevices.removeEventListener called.")})}},{"../utils.js":8}],5:[function(e,t,i){var r=e("../utils").browserDetails,o={shimOnTrack:function(){"object"!=("undefined"==typeof window?"undefined":n(window))||!window.RTCPeerConnection||"ontrack"in window.RTCPeerConnection.prototype||Object.defineProperty(window.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){this._ontrack&&(this.removeEventListener("track",this._ontrack),this.removeEventListener("addstream",this._ontrackpoly)),this.addEventListener("track",this._ontrack=e),this.addEventListener("addstream",this._ontrackpoly=function(e){e.stream.getTracks().forEach(function(t){var n=new Event("track");n.track=t,n.receiver={track:t},n.streams=[e.stream],this.dispatchEvent(n)}.bind(this))}.bind(this))}})},shimSourceObject:function(){"object"==("undefined"==typeof window?"undefined":n(window))&&(!window.HTMLMediaElement||"srcObject"in window.HTMLMediaElement.prototype||Object.defineProperty(window.HTMLMediaElement.prototype,"srcObject",{get:function(){return this.mozSrcObject},set:function(e){this.mozSrcObject=e}}))},shimPeerConnection:function(){if("object"==("undefined"==typeof window?"undefined":n(window))&&(window.RTCPeerConnection||window.mozRTCPeerConnection)){window.RTCPeerConnection||(window.RTCPeerConnection=function(e,t){if(r.version<38&&e&&e.iceServers){for(var n=[],i=0;i<e.iceServers.length;i++){var o=e.iceServers[i];if(o.hasOwnProperty("urls"))for(var a=0;a<o.urls.length;a++){var s={url:o.urls[a]};0===o.urls[a].indexOf("turn")&&(s.username=o.username,s.credential=o.credential),n.push(s)}else n.push(e.iceServers[i])}e.iceServers=n}return new mozRTCPeerConnection(e,t)},window.RTCPeerConnection.prototype=mozRTCPeerConnection.prototype,mozRTCPeerConnection.generateCertificate&&Object.defineProperty(window.RTCPeerConnection,"generateCertificate",{get:function(){return mozRTCPeerConnection.generateCertificate}}),window.RTCSessionDescription=mozRTCSessionDescription,window.RTCIceCandidate=mozRTCIceCandidate),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(e){var t=RTCPeerConnection.prototype[e];RTCPeerConnection.prototype[e]=function(){return arguments[0]=new("addIceCandidate"===e?RTCIceCandidate:RTCSessionDescription)(arguments[0]),t.apply(this,arguments)}});var e=RTCPeerConnection.prototype.addIceCandidate;RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?e.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())};var t=function(e){var t=new Map;return Object.keys(e).forEach(function(n){t.set(n,e[n]),t[n]=e[n]}),t},i={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},o=RTCPeerConnection.prototype.getStats;RTCPeerConnection.prototype.getStats=function(e,n,a){return o.apply(this,[e||null]).then(function(e){return r.version<48&&(e=t(e)),r.version<53&&!n&&e.forEach(function(e){e.type=i[e.type]||e.type}),e}).then(n,a)}}}};t.exports={shimOnTrack:o.shimOnTrack,shimSourceObject:o.shimSourceObject,shimPeerConnection:o.shimPeerConnection,shimGetUserMedia:e("./getusermedia")}},{"../utils":8,"./getusermedia":6}],6:[function(e,t,i){var r=e("../utils").log,o=e("../utils").browserDetails;t.exports=function(){var e=function(e){return{name:{SecurityError:"NotAllowedError",PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:{"The operation is insecure.":"The request is not allowed by the user agent or the platform in the current context."}[e.message]||e.message,constraint:e.constraint,toString:function(){return this.name+(this.message&&": ")+this.message}}},t=function(t,i,a){var s=function(e){if("object"!=("undefined"==typeof e?"undefined":n(e))||e.require)return e;var t=[];return Object.keys(e).forEach(function(i){if("require"!==i&&"advanced"!==i&&"mediaSource"!==i){var r=e[i]="object"==n(e[i])?e[i]:{ideal:e[i]};if(void 0===r.min&&void 0===r.max&&void 0===r.exact||t.push(i),void 0!==r.exact&&("number"==typeof r.exact?r.min=r.max=r.exact:e[i]=r.exact,delete r.exact),void 0!==r.ideal){e.advanced=e.advanced||[];var o={};"number"==typeof r.ideal?o[i]={min:r.ideal,max:r.ideal}:o[i]=r.ideal,e.advanced.push(o),delete r.ideal,Object.keys(r).length||delete e[i]}}}),t.length&&(e.require=t),e};return t=JSON.parse(JSON.stringify(t)),o.version<38&&(r("spec: "+JSON.stringify(t)),t.audio&&(t.audio=s(t.audio)),t.video&&(t.video=s(t.video)),r("ff37: "+JSON.stringify(t))),navigator.mozGetUserMedia(t,i,function(t){a(e(t))})},i=function(e){return new Promise(function(n,i){t(e,n,i)})};if(navigator.mediaDevices||(navigator.mediaDevices={getUserMedia:i,addEventListener:function(){},removeEventListener:function(){}}),navigator.mediaDevices.enumerateDevices=navigator.mediaDevices.enumerateDevices||function(){return new Promise(function(e){var t=[{kind:"audioinput",deviceId:"default",label:"",groupId:""},{kind:"videoinput",deviceId:"default",label:"",groupId:""}];e(t)})},o.version<41){var a=navigator.mediaDevices.enumerateDevices.bind(navigator.mediaDevices);navigator.mediaDevices.enumerateDevices=function(){return a().then(void 0,function(e){if("NotFoundError"===e.name)return[];throw e})}}if(o.version<49){var s=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(t){return s(t).then(function(e){if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length)throw e.getTracks().forEach(function(e){e.stop()}),new DOMException("The object can not be found here.","NotFoundError");return e},function(t){return Promise.reject(e(t))})}}navigator.getUserMedia=function(e,n,i){return o.version<44?t(e,n,i):(console.warn("navigator.getUserMedia has been replaced by navigator.mediaDevices.getUserMedia"),void navigator.mediaDevices.getUserMedia(e).then(n,i))}}},{"../utils":8}],7:[function(e,t,n){var i={shimGetUserMedia:function(){navigator.getUserMedia=navigator.webkitGetUserMedia}};t.exports={shimGetUserMedia:i.shimGetUserMedia}},{}],8:[function(e,t,i){var r=!0,o={disableLog:function(e){return"boolean"!=typeof e?new Error("Argument type: "+("undefined"==typeof e?"undefined":n(e))+". Please use a boolean."):(r=e,e?"adapter.js logging disabled":"adapter.js logging enabled")},log:function(){if("object"==("undefined"==typeof window?"undefined":n(window))){if(r)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}},extractVersion:function(e,t,n){var i=e.match(t);return i&&i.length>=n&&parseInt(i[n],10)},detectBrowser:function(){var e={};if(e.browser=null,e.version=null,"undefined"==typeof window||!window.navigator)return e.browser="Not a browser.",e;if(navigator.mozGetUserMedia)e.browser="firefox",e.version=this.extractVersion(navigator.userAgent,/Firefox\/([0-9]+)\./,1);else if(navigator.webkitGetUserMedia)if(window.webkitRTCPeerConnection)e.browser="chrome",e.version=this.extractVersion(navigator.userAgent,/Chrom(e|ium)\/([0-9]+)\./,2);else{if(!navigator.userAgent.match(/Version\/(\d+).(\d+)/))return e.browser="Unsupported webkit-based browser with GUM support but no WebRTC support.",e;e.browser="safari",e.version=this.extractVersion(navigator.userAgent,/AppleWebKit\/([0-9]+)\./,1)}else{if(!navigator.mediaDevices||!navigator.userAgent.match(/Edge\/(\d+).(\d+)$/))return e.browser="Not a supported browser.",e;e.browser="edge",e.version=this.extractVersion(navigator.userAgent,/Edge\/(\d+).(\d+)$/,2)}return e},shimCreateObjectURL:function(){var e=URL.createObjectURL.bind(URL),t=URL.revokeObjectURL.bind(URL),n=new Map,i=0;URL.createObjectURL=function(t){if("getTracks"in t){var r="polyblob:"+ ++i;return n.set(r,t),console.log("URL.createObjectURL(stream) is deprecated! Use elem.srcObject = stream instead!"),r}return e(t)},URL.revokeObjectURL=function(e){t(e),n.delete(e)};var r=Object.getOwnPropertyDescriptor(window.HTMLMediaElement.prototype,"src");Object.defineProperty(window.HTMLMediaElement.prototype,"src",{get:function(){return r.get.apply(this)},set:function(e){return this.srcObject=n.get(e)||null,r.set.apply(this,[e])}})}};t.exports={log:o.log,disableLog:o.disableLog,browserDetails:o.detectBrowser(),extractVersion:o.extractVersion,shimCreateObjectURL:o.shimCreateObjectURL}},{}]},{},[2]);var O=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i(this,e),this.wasClean=t.wasClean,this.code=t.code,this.reason=t.reason},C=function(){function e(){i(this,e)}return r(e,null,[{key:"createCloseEvent",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],r={wasClean:i,code:t,reason:n};return e.isBrowser()?new CloseEvent("netfluxClose",r):new O(r)}},{key:"isBrowser",value:function(){return"undefined"!=typeof window&&("undefined"==typeof process||"node"!==process.title)}},{key:"isSocket",value:function(e){return"WebSocket"===e.constructor.name}},{key:"isURL",value:function(e){var t="^(?:(?:wss|ws|http|https)://)(?:\\S+(?::\\S*)?@)?(?:",n="(?:\\.(?:[a-z\\u00a1-\\uffff]{2,}))?";return t+="(?:[1-9]\\d?|1\\d\\d|2[01]\\d|22[0-3])(?:\\.(?:1?\\d{1,2}|2[0-4]\\d|25[0-5])){2}(?:\\.(?:[1-9]\\d?|1\\d\\d|2[0-4]\\d|25[0-4]))|(?:(?:[a-z\\u00a1-\\uffff0-9]-*)*[a-z\\u00a1-\\uffff0-9]+)(?:\\.(?:[a-z\\u00a1-\\uffff0-9]-*)*[a-z\\u00a1-\\uffff0-9]+)*"+n+")(?::\\d{2,5})?(?:[/?#]\\S*)?$",!!new RegExp(t,"i").exec(e)}},{key:"require",value:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e){try{return require(e)}catch(t){return void console.error(e+" could not be found: "+t)}})},{key:"requireLib",value:function(t){switch(t){case e.WEB_RTC_LIB:return e.isBrowser()?window:e.require("wrtc");case e.WEB_SOCKET_LIB:return e.isBrowser()?window.WebSocket:e.require("ws");case e.TEXT_ENCODING_LIB:return e.isBrowser()?window:e.require("text-encoding");case e.EVENT_SOURCE_LIB:return e.isBrowser()?window.EventSource:e.require("eventsource");case e.XML_HTTP_REQUEST_LIB:return e.isBrowser()?window.XMLHttpRequest:e.require("xmlhttprequest").XMLHttpRequest;default:return void console.error(t+" is unknown lib constant. See Util")}}},{key:"WEB_RTC_LIB",get:function(){return 1}},{key:"WEB_SOCKET_LIB",get:function(){return 2}},{key:"TEXT_ENCODING_LIB",get:function(){return 3}},{key:"EVENT_SOURCE_LIB",get:function(){return 4}},{key:"XML_HTTP_REQUEST_LIB",get:function(){return 5}}]),e}(),_=C.requireLib(C.WEB_RTC_LIB),k=3e4,I=5e3,T=function(e){function t(e,n){i(this,t);var r=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return r.iceServers=n,r}return a(t,e),r(t,[{key:"onMessage",value:function(e,n,i,r){var a=this,s=e.webChannel,c=o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"getItem",this).call(this,s,n);c||(c=new S,o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"setItem",this).call(this,s,n,c)),"offer"in r&&(c.pc=this.createPeerConnection(function(e){s.sendInnerTo(n,a.id,{candidate:e})}),this.listenOnDataChannel(c.pc,function(e){setTimeout(function(){return o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"removeItem",a).call(a,s,n)},I),Oe.get(ye).onChannel(s,e,n)}),this.createAnswer(c.pc,r.offer,c.candidates).then(function(e){return s.sendInnerTo(n,a.id,{answer:e})}).catch(function(e){return console.error("During Establishing dataChannel connection over webChannel: "+e.message)})),"answer"in r?c.pc.setRemoteDescription(r.answer).then(function(){return c.pc.addReceivedCandidates(c.candidates)}).catch(function(e){return console.error("Set answer (webChannel): "+e.message)}):"candidate"in r&&this.addIceCandidate(c,r.candidate)}},{key:"connectOverWebChannel",value:function(e,n){var i=this,r=new S(this.createPeerConnection(function(t){e.sendInnerTo(n,i.id,{candidate:t})}));return o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"setItem",this).call(this,e,n,r),new Promise(function(a,s){setTimeout(s,k,"WebRTC connect timeout"),i.createDataChannel(r.pc,function(r){setTimeout(function(){return o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"removeItem",i).call(i,e,n)},I),a(r)}),i.createOffer(r.pc).then(function(t){return e.sendInnerTo(n,i.id,{offer:t})}).catch(s)})}},{key:"listenFromSignaling",value:function(e,n){var i=this;e.onmessage=function(r){var a=JSON.parse(r.data);if("id"in a&&"data"in a){var s=o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"getItem",i).call(i,e,a.id);s||(s=new S(i.createPeerConnection(function(t){1===e.readyState&&e.send(JSON.stringify({id:a.id,data:{candidate:t}}))})),o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"setItem",i).call(i,e,a.id,s)),"offer"in a.data?(i.listenOnDataChannel(s.pc,function(r){setTimeout(function(){return o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"removeItem",i).call(i,e,a.id)},I),n(r)}),i.createAnswer(s.pc,a.data.offer,s.candidates).then(function(t){e.send(JSON.stringify({id:a.id,data:{answer:t}}))}).catch(function(e){console.error("During establishing data channel connection through signaling: "+e.message)})):"candidate"in a.data&&i.addIceCandidate(s,a.data.candidate)}}}},{key:"connectOverSignaling",value:function(e,n){var i=this,r=new S(this.createPeerConnection(function(t){1===e.readyState&&e.send(JSON.stringify({data:{candidate:t}}))}));return o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"setItem",this).call(this,e,n,r),new Promise(function(a,s){e.onclose=function(e){return s(e.reason)},e.onmessage=function(a){try{var c=JSON.parse(a.data);"data"in c&&("answer"in c.data?r.pc.setRemoteDescription(c.data.answer).then(function(){return r.pc.addReceivedCandidates(r.candidates);
}).catch(function(e){return s("Set answer (signaling): "+e.message)}):"candidate"in c.data&&i.addIceCandidate(o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"getItem",i).call(i,e,n),c.data.candidate))}catch(t){s("Unknown message from the server "+e.url+": "+a.data)}},i.createDataChannel(r.pc,function(r){setTimeout(function(){return o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"removeItem",i).call(i,e,n)},I),a(r)}),i.createOffer(r.pc).then(function(t){return e.send(JSON.stringify({data:{offer:t}}))}).catch(s)})}},{key:"createOffer",value:function(e){return e.createOffer().then(function(t){return e.setLocalDescription(t)}).then(function(){return{type:e.localDescription.type,sdp:e.localDescription.sdp}})}},{key:"createAnswer",value:function(e,t,n){return e.setRemoteDescription(t).then(function(){return e.addReceivedCandidates(n),e.createAnswer()}).then(function(t){return e.setLocalDescription(t)}).then(function(){return{type:e.localDescription.type,sdp:e.localDescription.sdp}})}},{key:"createPeerConnection",value:function(e){var t=this,n=new _.RTCPeerConnection({iceServers:this.iceServers});return n.isRemoteDescriptionSet=!1,n.addReceivedCandidates=function(e){n.isRemoteDescriptionSet=!0;var i=!0,r=!1,o=void 0;try{for(var a,s=e[Symbol.iterator]();!(i=(a=s.next()).done);i=!0){var c=a.value;t.addIceCandidate({pc:n},c)}}catch(e){r=!0,o=e}finally{try{!i&&s.return&&s.return()}finally{if(r)throw o}}},n.onicecandidate=function(t){if(null!==t.candidate){var n={candidate:t.candidate.candidate,sdpMid:t.candidate.sdpMid,sdpMLineIndex:t.candidate.sdpMLineIndex};e(n)}},n}},{key:"createDataChannel",value:function(e,t){var n=e.createDataChannel(null);n.onopen=function(e){return t(n)},this.setUpOnDisconnect(e,n)}},{key:"listenOnDataChannel",value:function(e,t){var n=this;e.ondatachannel=function(i){n.setUpOnDisconnect(e,i.channel),i.channel.onopen=function(e){return t(i.channel)}}}},{key:"setUpOnDisconnect",value:function(e,t){e.oniceconnectionstatechange=function(){"disconnected"===e.iceConnectionState&&t.onclose&&t.onclose(C.createCloseEvent(4201,"disconnected",!1))}}},{key:"addIceCandidate",value:function(e,t){null!==e&&e.pc&&e.pc.isRemoteDescriptionSet?e.pc.addIceCandidate(new _.RTCIceCandidate(t)).catch(function(e){return console.error("Add ICE candidate: "+e.message)}):e.candidates[e.candidates.length]=t}}]),t}(h),S=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];i(this,e),this.pc=t,this.candidates=n},P=C.requireLib(C.WEB_SOCKET_LIB),R=2e3,E=function(e){function t(){return i(this,t),s(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return a(t,e),r(t,[{key:"connect",value:function(e){return new Promise(function(t,n){try{!function(){var i=new P(e);i.onopen=function(){return t(i)},setTimeout(function(){i.readyState!==i.OPEN&&n("WebSocket connection timeout with "+e+" within "+R+"ms")},R)}()}catch(e){n(e.message)}})}}]),t}(h),j=C.requireLib(C.EVENT_SOURCE_LIB),U=C.requireLib(C.XML_HTTP_REQUEST_LIB),L=2e3,M=6e3,D=function(e){function t(){return i(this,t),s(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return a(t,e),r(t,[{key:"connect",value:function(e){return new Promise(function(t,n){try{!function(){var i=new x(e);i.addEventListener("auth",function(e){i.auth=e.data,void 0===i.OPEN&&(i.OPEN=1),i.nativeClose=i.close,i.close=function(){"function"==typeof this.onclose&&this.onclose(C.createCloseEvent("close")),this.nativeClose()},t(i)}),i.onerror=function(e){return n(e.message)},setTimeout(function(){n("Authentication event has not been received from "+e+" within "+L+"ms")},L)}()}catch(e){n(e.message)}})}}]),t}(h),x=function(e){function t(e){i(this,t);var n=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.auth="",n.reconnectTimeout=null,n.onopen=function(){n.reconnectTimeout&&clearTimeout(n.reconnectTimeout)},n}return a(t,e),r(t,[{key:"send",value:function(){var e=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",i=new U;i.open("POST",this.url,!0),i.onload=function(){200!==i.status&&o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"onerror",e).call(e,new Error(i.statusText))},i.onerror=function(n){return o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"onerror",e).call(e,new Error(n.message))},i.send(this.auth+"@"+n)}},{key:"onerror",set:function(e){var n=this;c(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"onerror",function(t){e(t),n.reconnectTimeout||(n.reconnectTimeout=setTimeout(function(){n.close()},M))},this)}}]),t}(j),W=function(e){function t(e){i(this,t);var n=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.WS=[ve],n.WR=[pe],n.WS_WR=[ve,pe],n.WR_WS=[pe,ve],n}return a(t,e),r(t,[{key:"connectTo",value:function(e,n){var i=this;return new Promise(function(r,a){o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"setPendingRequest",i).call(i,e,n,{resolve:r,reject:a}),e.sendInnerTo(n,i.id,i.availableConnectors(e))})}},{key:"availableConnectors",value:function(e){var t={},n=[];return void 0!==C.requireLib(C.WEB_RTC_LIB)&&(n[n.length]=pe),""!==e.settings.listenOn&&(n[n.length]=ve,t.listenOn=e.settings.listenOn),2===n.length&&n[0]!==e.settings.connector&&n.reverse(),t.connectors=n,t}},{key:"onChannel",value:function(e,n,i){var r=this;e.initChannel(n,i).then(function(n){var a=o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"getPendingRequest",r).call(r,e,i);null!==a&&a.resolve(n)})}},{key:"onMessage",value:function(e,n,i,r){var a=this,s=e.webChannel,c=this.availableConnectors(s),u=c.connectors;"failedReason"in r?o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"getPendingRequest",this).call(this,s,n).reject(r.failedReason):"shouldConnect"in r?this.isEqual(r.shouldConnect,this.WS)?Oe.get(ve).connect(r.listenOn).then(function(e){e.send(JSON.stringify({wcId:s.id,senderId:s.myId})),a.onChannel(s,e,n)}).catch(function(e){o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"getPendingRequest",a).call(a,s,n).reject("Failed to establish a socket: "+e)}):this.isEqual(r.shouldConnect,this.WS_WR)&&Oe.get(ve).connect(r.listenOn).then(function(e){e.send(JSON.stringify({wcId:s.id,senderId:s.myId})),a.onChannel(s,e,n)}).catch(function(e){return Oe.get(pe,s.settings.iceServers).connectOverWebChannel(s,n)}).then(function(e){return a.onChannel(s,e,n)}).catch(function(e){"feedbackOnFail"in r&&r.feedbackOnFail===!0?s.sendInnerTo(n,a.id,{tryOn:a.WS,listenOn:c.listenOn}):o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"getPendingRequest",a).call(a,s,n).reject("Failed to establish a socket and then a data channel: "+e)}):"tryOn"in r&&this.isEqual(r.tryOn,this.WS)?Oe.get(ve).connect(r.listenOn).then(function(e){e.send(JSON.stringify({wcId:s.id,senderId:s.myId})),a.onChannel(s,e,n)}).catch(function(e){return s.sendInnerTo(n,a.id,{failedReason:"Failed to establish a socket: "+e})}):"connectors"in r&&(this.isValid(r.connectors)?(0===r.connectors.length&&(0===u.length||this.isEqual(u,this.WS)?s.sendInnerTo(n,this.id,{failedReason:"No common connectors"}):s.sendInnerTo(n,this.id,{shouldConnect:this.WS,listenOn:c.listenOn})),this.isEqual(r.connectors,this.WS)&&(0===u.length||this.isEqual(u,this.WS)?this.ws(s,n,r.listenOn):this.wsWs(s,n,r.listenOn,c.listenOn)),this.isEqual(r.connectors,this.WR)&&(0===u.length?s.sendInnerTo(n,this.id,{failedReason:"No common connectors"}):this.isEqual(u,this.WS)?s.sendInnerTo(n,this.id,{shouldConnect:this.WS,listenOn:c.listenOn}):this.isEqual(u,this.WR)?Oe.get(pe,s.settings.iceServers).connectOverWebChannel(s,n).then(function(e){return a.onChannel(s,e,n)}).catch(function(e){s.sendInnerTo(n,a.id,{failedReason:"Failed establish a data channel: "+e})}):this.isEqual(u,this.WS_WR)?s.sendInnerTo(n,this.id,{shouldConnect:this.WS_WR,listenOn:c.listenOn}):this.isEqual(u,this.WR_WS)&&Oe.get(pe,s.settings.iceServers).connectOverWebChannel(s,n).then(function(e){return a.onChannel(s,e,n)}).catch(function(e){s.sendInnerTo(n,a.id,{shouldConnect:a.WS,listenOn:c.listenOn})})),this.isEqual(r.connectors,this.WS_WR)&&(0===u.length?this.ws(s,n,r.listenOn):this.isEqual(u,this.WS)?this.wsWs(s,n,r.listenOn,c.listenOn):this.isEqual(u,this.WR)?Oe.get(ve).connect(r.listenOn).then(function(e){e.send(JSON.stringify({wcId:s.id,senderId:s.myId})),a.onChannel(s,e,n)}).catch(function(e){return Oe.get(pe,s.settings.iceServers).connectOverWebChannel(s,n)}).then(function(e){return a.onChannel(s,e,n)}).catch(function(e){return s.sendInnerTo(n,a.id,{failedReason:"Failed to establish a socket and then a data channel: "+e})}):this.isEqual(u,this.WS_WR)?Oe.get(ve).connect(r.listenOn).then(function(e){e.send(JSON.stringify({wcId:s.id,senderId:s.myId})),a.onChannel(s,e,n)}):this.isEqual(u,this.WR_WS)?s.sendInnerTo(n,this.id,{shouldConnect:this.WS_WR,listenOn:c.listenOn}):Oe.get(ve).connect(r.listenOn).then(function(e){e.send(JSON.stringify({wcId:s.id,senderId:s.myId})),a.onChannel(s,e,n)}).catch(function(e){return Oe.get(pe,s.settings.iceServers).connectOverWebChannel(s,n)}).then(function(e){return a.onChannel(s,e,n)}).catch(function(e){return s.sendInnerTo(n,a.id,{shouldConnect:a.WS,listenOn:c.listenOn})})),this.isEqual(r.connectors,this.WR_WS)&&(0===u.length?this.ws(s,n,r.listenOn):this.isEqual(u,this.WS)?this.wsWs(s,n,r.listenOn,c.listenOn):this.isEqual(u,this.WR)?Oe.get(pe,s.settings.iceServers).connectOverWebChannel(s,n).then(function(e){return a.onChannel(s,e,n)}).catch(function(e){return Oe.get(ve).connect(r.listenOn)}).then(function(e){e.send(JSON.stringify({wcId:s.id,senderId:s.myId})),a.onChannel(s,e,n)}).catch(function(e){return s.sendInnerTo(n,a.id,{failedReason:"Failed to establish a data channel and then a socket: "+e})}):this.isEqual(u,this.WS_WR)?s.sendInnerTo(n,this.id,{shouldConnect:this.WS_WR,feedbackOnFail:!0,listenOn:c.listenOn}):this.isEqual(u,this.WR_WS)&&Oe.get(pe,s.settings.iceServers).connectOverWebChannel(s,n).then(function(e){return a.onChannel(s,e,n)}).catch(function(e){return Oe.get(ve).connect(r.listenOn)}).then(function(e){e.send(JSON.stringify({wcId:s.id,senderId:s.myId})),a.onChannel(s,e,n)}).catch(function(e){return s.sendInnerTo(n,a.id,{shouldConnect:a.WS,listenOn:c.listenOn})}))):s.sendInnerTo(n,this.id,{failedReason:"Unknown connectors: "+r.connectors}))}},{key:"wsWs",value:function(e,t,n,i){var r=this;Oe.get(ve).connect(n).then(function(n){n.send(JSON.stringify({wcId:e.id,senderId:e.myId})),r.onChannel(e,n,t)}).catch(function(n){e.sendInnerTo(t,r.id,{shouldConnect:r.WS,listenOn:i})})}},{key:"ws",value:function(e,t,n){var i=this;Oe.get(ve).connect(n).then(function(n){n.send(JSON.stringify({wcId:e.id,senderId:e.myId})),i.onChannel(e,n,t)}).catch(function(n){e.sendInnerTo(t,i.id,{failedReason:"Failed to establish a socket: "+n})})}},{key:"isValid",value:function(e){return!!(this.isEqual(e,this.WS)||this.isEqual(e,this.WR)||this.isEqual(e,this.WS_WR)||this.isEqual(e,this.WR_WS))}},{key:"isEqual",value:function(e,t){if(e.length!==t.length)return!1;for(var n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0}}]),t}(h),N=function(){function e(t,n,r){i(this,e),this.channel=t,this.webChannel=null,this.peerId=-1,this.send=null,C.isBrowser()?(t.binaryType="arraybuffer",this.send=this.sendBrowser):C.isSocket(t)?this.send=this.sendInNodeThroughSocket:(t.binaryType="arraybuffer",this.send=this.sendInNodeThroughDataChannel)}return r(e,[{key:"sendBrowser",value:function(e){if(this.isOpen())try{this.channel.send(e)}catch(e){console.error("Channel send: "+e.message)}}},{key:"sendInNodeThroughSocket",value:function(e){if(this.isOpen())try{this.channel.send(e,{binary:!0})}catch(e){console.error("Channel send: "+e.message)}}},{key:"sendInNodeThroughDataChannel",value:function(e){this.sendBrowser(e.slice(0))}},{key:"clearHandlers",value:function(){this.onMessage=function(){},this.onClose=function(){},this.onError=function(){}}},{key:"isOpen",value:function(){var e=this.channel.readyState;return 1===e||"open"===e}},{key:"close",value:function(){this.channel.close()}},{key:"onMessage",set:function(e){!C.isBrowser()&&C.isSocket(this.channel)?this.channel.onmessage=function(t){e(new Uint8Array(t.data).buffer)}:this.channel.onmessage=function(t){return e(t.data)}}},{key:"onClose",set:function(e){var t=this;this.channel.onclose=function(n){null!==t.webChannel&&e(n)?(t.webChannel.members.splice(t.webChannel.members.indexOf(t.peerId),1),t.webChannel.onPeerLeave(t.peerId)):e(n)}}},{key:"onError",set:function(e){this.channel.onerror=function(t){return e(t)}}}]),e}(),q=function(){function e(t){i(this,e),this.webChannel=t,this.url=null,this.key=null,this.con=null}return r(e,[{key:"open",value:function(e,t){var n=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return new Promise(function(r,o){null===i&&(i=n.generateKey()),n.getConnectionService(e).connect(e).then(function(a){a.onclose=function(e){n.key=null,n.con=null,n.url=null,n.webChannel.onClose(e),o(e.reason)},a.onerror=function(e){o(e.message)},a.onmessage=function(s){try{var c=JSON.parse(s.data);"isKeyOk"in c?c.isKeyOk?(Oe.get(pe,n.webChannel.settings.iceServers).listenFromSignaling(a,t),n.con=a,n.key=i,n.url=e,r({url:e,key:i})):o(i+" key already exists"):o("Unknown message from "+e+": "+s.data)}catch(e){o("Server responce is not a JSON string: "+e.message)}},a.send(JSON.stringify({open:i}))}).catch(function(e){o(e)})})}},{key:"join",value:function(e,t){var n=this;return new Promise(function(i,r){n.getConnectionService(e).connect(e).then(function(o){o.onclose=function(e){return r(e.reason)},o.onmessage=function(a){try{var s=JSON.parse(a.data);"isKeyOk"in s?s.isKeyOk?"useThis"in s&&s.useThis?i(o):Oe.get(pe,n.webChannel.settings.iceServers).connectOverSignaling(o,t).then(function(e){o.onclose=null,o.close(),i(e)}).catch(r):r('The key "'+t+'" not found'):r("Unknown message from "+e+": "+a.data)}catch(e){r(e.message)}},o.send(JSON.stringify({join:t}))}).catch(r)})}},{key:"isOpen",value:function(){return null!==this.con&&this.con.readyState===this.con.OPEN}},{key:"getOpenData",value:function(){return this.isOpen()?{url:this.url,key:this.key}:null}},{key:"close",value:function(){this.isOpen()&&this.con.close()}},{key:"getConnectionService",value:function(e){if(C.isURL(e))return e.search(/^wss?/)!==-1?Oe.get(ve):Oe.get(ge);throw new Error(e+" is not a valid URL")}},{key:"generateKey",value:function(){for(var e=5,t=0,n="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",i="",r=e+Math.round(Math.random()*t),o=0;o<r;o++)i+=n[Math.round(Math.random()*(n.length-1))];return i}}]),e}(),B=2147483647,A=5e3,J=1e4,F=1,z=2,H=3,V=4,G=5,K=function(){function e(t){i(this,e),this.settings=t,this.channels=new Set,this.onJoin=function(){},this.manager=Oe.get(this.settings.topology),this.msgBld=Oe.get(we),this.members=[],this.generatedIds=new Set,this.pingTime=0,this.maxTime=0,this.pingFinish=function(){},this.pongNb=0,this.gate=new q(this),this.id=this.generateId(),this.myId=this.generateId(),this.onPeerJoin=function(){},this.onPeerLeave=function(){},this.onMessage=function(){},this.onClose=function(){}}return r(e,[{key:"join",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.settings.signalingURL;return new Promise(function(i,r){t.onJoin=i,"WebSocket"!==e.constructor.name?t.gate.join(n,e).then(function(e){return t.initChannel(e)}).catch(r):t.initChannel(e).catch(r)})}},{key:"invite",value:function(e){var t=this;return"string"==typeof e||e instanceof String?C.isURL(e)?Oe.get(ve).connect(e).then(function(e){return e.send(JSON.stringify({wcId:t.id})),t.addChannel(e)}):Promise.reject(e+" is not a valid URL"):"WebSocket"===e.constructor.name?this.addChannel(e):Promise.reject(e+" is not a valid URL")}},{key:"open",value:function(e){var t=this,n={url:this.settings.signalingURL,key:null},i=Object.assign({},n,e);return C.isURL(i.url)?this.gate.open(i.url,function(e){return t.addChannel(e)},i.key):Promise.reject(i.url+" is not a valid URL")}},{key:"close",value:function(){this.gate.close()}},{key:"isOpen",value:function(){return this.gate.isOpen()}},{key:"getOpenData",value:function(){return this.gate.getOpenData()}},{key:"leave",value:function(){0!==this.channels.size&&(this.members=[],this.pingTime=0,this.gate.close(),this.manager.leave(this))}},{key:"send",value:function(e){var t=this;0!==this.channels.size&&this.msgBld.handleUserMessage(e,this.myId,null,function(e){t.manager.broadcast(t,e)})}},{key:"sendTo",value:function(e,t){var n=this;0!==this.channels.size&&this.msgBld.handleUserMessage(t,this.myId,e,function(t){n.manager.sendTo(e,n,t)},!1)}},{key:"ping",value:function(){var e=this;return 0!==this.channels.size&&0===this.pingTime?new Promise(function(t,n){0===e.pingTime&&(e.pingTime=Date.now(),e.maxTime=0,e.pongNb=0,e.pingFinish=function(e){return t(e)},e.manager.broadcast(e,e.msgBld.msg(V,e.myId)),setTimeout(function(){return t(A)},A))}):Promise.reject("No peers to ping")}},{key:"addChannel",value:function(e){var t=this;return this.initChannel(e).then(function(e){var n=t.msgBld.msg(H,t.myId,e.peerId,{manager:t.manager.id,wcId:t.id});return e.send(n),t.manager.add(e)})}},{key:"onPeerJoin$",value:function(e){this.members[this.members.length]=e,this.onPeerJoin(e)}},{key:"onPeerLeave$",value:function(e){this.members.splice(this.members.indexOf(e),1),this.onPeerLeave(e)}},{key:"sendInnerTo",value:function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(i)this.manager.sendInnerTo(e,this,n);else if(Number.isInteger(e)){var r=this.msgBld.msg(z,this.myId,e,{serviceId:t,data:n});this.manager.sendInnerTo(e,this,r)}else e.send(this.msgBld.msg(z,this.myId,e.peerId,{serviceId:t,data:n}))}},{key:"sendInner",value:function(e,t){this.manager.sendInner(this,this.msgBld.msg(z,this.myId,null,{serviceId:e,data:t}))}},{key:"onChannelMessage",value:function(e,t){var n=this,i=this.msgBld.readHeader(t);if(i.code===F)this.msgBld.readUserMessage(this,i.senderId,t,function(e,t){n.onMessage(i.senderId,e,t)});else{var r=this.msgBld.readInternalMessage(t);switch(i.code){case H:this.settings.topology=r.manager,this.manager=Oe.get(this.settings.topology),this.myId=i.recepientId,this.id=r.wcId,e.peerId=i.senderId;break;case z:0===i.recepientId||this.myId===i.recepientId?this.getService(r.serviceId).onMessage(e,i.senderId,i.recepientId,r.data):this.sendInnerTo(i.recepientId,null,t,!0);break;case V:this.manager.sendTo(i.senderId,this,this.msgBld.msg(G,this.myId));break;case G:var o=Date.now();this.pongNb++,this.maxTime=Math.max(this.maxTime,o-this.pingTime),this.pongNb===this.members.length&&(this.pingFinish(this.maxTime),this.pingTime=0);break;default:throw new Error('Unknown message type code: "'+i.code+'"')}}}},{key:"initChannel",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1;n===-1&&(n=this.generateId());var i=new N(e);return i.peerId=n,i.webChannel=this,i.onMessage=function(e){return t.onChannelMessage(i,e)},i.onClose=function(e){return t.manager.onChannelClose(e,i)},i.onError=function(e){return t.manager.onChannelError(e,i)},Promise.resolve(i)}},{key:"getService",value:function(e){return e===pe?Oe.get(pe,this.settings.iceServers):Oe.get(e)}},{key:"generateId",value:function(){for(var e=this,t=function(){var t=Math.ceil(Math.random()*B);return t===e.myId?"continue":e.members.includes(t)?"continue":e.generatedIds.has(t)?"continue":(e.generatedIds.add(t),setTimeout(function(){return e.generatedIds.delete(t)},J),{v:t})};;){var i=t();switch(i){case"continue":continue;default:if("object"===("undefined"==typeof i?"undefined":n(i)))return i.v}}}}]),e}(),X=C.requireLib(C.TEXT_ENCODING_LIB),$=16365,Q=19,Y=9,Z=65535,ee=1,te=2,ne=3,ie=4,re=5,oe=6,ae=7,se=8,ce=9,ue=10,de=11,le=new WeakMap,he=function(e){function t(){return i(this,t),s(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return a(t,e),r(t,[{key:"handleUserMessage",value:function(e,t,n,i){var r=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],o=this.userDataToType(e),a=o.content;if(a.byteLength<=$){var s=this.initHeader(1,t,n,a.byteLength+Q);s.setUint32(Y,a.byteLength),s.setUint8(13,o.type),s.setUint8(14,r?1:0);var c=new Uint8Array(s.buffer);c.set(a,Q),i(c.buffer)}else for(var u=Math.ceil(Math.random()*Z),d=Math.ceil(a.byteLength/$),l=0;l<d;l++){var h=Math.min($,a.byteLength-$*l),f=this.initHeader(F,t,n,Q+h);f.setUint32(9,a.byteLength),f.setUint8(13,o.type),f.setUint8(14,r?1:0),f.setUint16(15,u),f.setUint16(17,l);for(var p=new Uint8Array(f.buffer),v=Q,g=$*l,y=g+h,m=g;m<y;m++)p[v++]=a[m];i(p.buffer)}}},{key:"msg",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},r=(new X.TextEncoder).encode(JSON.stringify(i)),o=r.byteLength+Y,a=this.initHeader(e,t,n,o),s=new Uint8Array(a.buffer);return s.set(r,Y),s.buffer}},{key:"readUserMessage",value:function(e,t,n,i){var r=this,o=new DataView(n),a=o.getUint32(Y),s=o.getUint8(13),c=o.getUint8(14);if(a>$){var u=o.getUint16(15),d=o.getUint16(17),l=this.getBuffer(e,t,u);void 0===l?this.setBuffer(e,t,u,new fe(a,n,d,function(e){i(r.extractUserData(e,s),c)})):l.add(n,d)}else{for(var h=new Uint8Array(n),f=new Uint8Array(n.byteLength-Q),p=Q,v=0;v<f.byteLength;v++)f[v]=h[p++];i(this.extractUserData(f.buffer,s),c)}}},{key:"readInternalMessage",value:function(e){var t=new Uint8Array(e);return JSON.parse((new X.TextDecoder).decode(t.subarray(Y,t.byteLength)))}},{key:"readHeader",value:function(e){var t=new DataView(e);return{code:t.getUint8(0),senderId:t.getUint32(1),recepientId:t.getUint32(5)}}},{key:"initHeader",value:function(e,t,n,i){var r=new DataView(new ArrayBuffer(i));return r.setUint8(0,e),r.setUint32(1,t),r.setUint32(5,n),r}},{key:"extractUserData",value:function(e,t){switch(t){case ee:return e;case te:return new Uint8Array(e);case ne:return(new X.TextDecoder).decode(new Uint8Array(e));case ie:return new Int8Array(e);case re:return new Uint8ClampedArray(e);case oe:return new Int16Array(e);case ae:return new Uint16Array(e);case se:return new Int32Array(e);case ce:return new Uint32Array(e);case ue:return new Float32Array(e);case de:return new Float64Array(e);default:throw new Error("Unknown type")}}},{key:"userDataToType",value:function(e){var t={};if(e instanceof ArrayBuffer)t.type=ee,t.content=new Uint8Array(e);else if(e instanceof Uint8Array)t.type=te,t.content=e;else if("string"==typeof e||e instanceof String)t.type=ne,t.content=(new X.TextEncoder).encode(e);else if(t.content=new Uint8Array(e.buffer),e instanceof Int8Array)t.type=ie;else if(e instanceof Uint8ClampedArray)t.type=re;else if(e instanceof Int16Array)t.type=oe;else if(e instanceof Uint16Array)t.type=ae;else if(e instanceof Int32Array)t.type=se;else if(e instanceof Uint32Array)t.type=ce;else if(e instanceof Float32Array)t.type=ue;else{if(!(e instanceof Float64Array))throw new Error("Unknown data object");t.type=de}return t}},{key:"getBuffer",value:function(e,t,n){var i=le.get(e);if(void 0!==i){var r=i.get(t);if(void 0!==r)return r.get(n)}}},{key:"setBuffer",value:function(e,t,n,i){var r=le.get(e);void 0===r&&(r=new Map,le.set(e,r));var o=r.get(t);void 0===o&&(o=new Map,r.set(t,o)),o.set(n,i)}}]),t}(h),fe=function(){function e(t,n,r,o){i(this,e),this.fullData=new Uint8Array(t),this.currentSize=0,this.action=o,this.add(n,r)}return r(e,[{key:"add",value:function(e,t){var n=new Uint8Array(e),i=e.byteLength;this.currentSize+=i-Q;for(var r=t*$,o=Q;o<i;o++)this.fullData[r++]=n[o];this.currentSize===this.fullData.byteLength&&this.action(this.fullData.buffer)}}]),e}(),pe=0,ve=1,ge=5,ye=2,me=3,we=4,be=new Map,Oe=function(){function e(){i(this,e)}return r(e,null,[{key:"get",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(be.has(e))return be.get(e);var n=void 0;switch(e){case pe:return new T(pe,t);case ve:return new E(ve);case ge:return new D(ge);case ye:return new W(ye);case me:return n=new w(me),be.set(e,n),n;case we:return n=new he(we),be.set(e,n),n;default:throw new Error(e+" is an Unknown service id")}}}]),e}(),Ce=4e3,_e=4001,ke=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i(this,e),this.defaultSettings={connector:ve,topology:me,signalingURL:"wss://sigver-coastteam.rhcloud.com:8443",iceServers:[{urls:"stun:turn01.uswest.xirsys.com"}],host:"localhost",port:9e3},this.settings=Object.assign({},this.defaultSettings,t),this.settings.listenOn="ws://"+this.settings.host+":"+this.settings.port,this.server=null,this.webChannels=[],this.onWebChannel=function(){}}return r(e,[{key:"start",value:function(){var e=this;return new Promise(function(t,n){var i=C.require("ws").Server;e.server=new i({host:e.settings.host,port:e.settings.port},t);var r=!0,o=!1,a=void 0;try{for(var s,c=e.webChannels[Symbol.iterator]();!(r=(s=c.next()).done);r=!0){var u=s.value;u.settings.listenOn=e.settings.listenOn}}catch(e){o=!0,a=e}finally{try{!r&&c.return&&c.return()}finally{if(o)throw a}}e.server.on("error",function(t){console.error("Server error: ",t);var i=!0,r=!1,o=void 0;try{for(var a,s=e.webChannels[Symbol.iterator]();!(i=(a=s.next()).done);i=!0){var c=a.value;c.settings.listenOn=""}}catch(e){r=!0,o=e}finally{try{!i&&s.return&&s.return()}finally{if(r)throw o}}n("Server error: "+t.messsage)}),e.server.on("connection",function(t){t.onmessage=function(n){try{var i=JSON.parse(n.data);if("join"in i){var r=e.getWebChannel(i.join);null===r?t.send(JSON.stringify({isKeyOk:!1})):(t.send(JSON.stringify({isKeyOk:!0,useThis:!0})),r.invite(t))}else"wcId"in i&&!function(){var n=e.getWebChannel(i.wcId);"senderId"in i?null!==n?Oe.get(ye).onChannel(n,t,i.senderId):(t.close(_e,i.wcId+" webChannel was not found (message received from "+i.senderId+")"),console.error(i.wcId+" webChannel was not found (message received from "+i.senderId+")")):null===n?(n=new K(e.settings),n.id=i.wcId,e.addWebChannel(n),n.join(t).then(function(){e.onWebChannel(n)})):0===n.members.length?(e.removeWebChannel(n),n=new K(e.settings),n.id=i.wcId,e.addWebChannel(n),n.join(t).then(function(){e.onWebChannel(n)})):console.error("Bot refused to join "+i.wcId+" webChannel, because it is already in use")}()}catch(e){t.close(Ce,"Unsupported message type: "+e.message),console.error("Unsupported message type: "+e.message)}}})})}},{key:"stop",value:function(){var e=!0,t=!1,n=void 0;try{for(var i,r=this.webChannels[Symbol.iterator]();!(e=(i=r.next()).done);e=!0){var o=i.value;o.settings.listenOn=""}}catch(e){t=!0,n=e}finally{try{!e&&r.return&&r.return()}finally{if(t)throw n}}this.server.close()}},{key:"getWebChannel",value:function(e){var t=!0,n=!1,i=void 0;try{for(var r,o=this.webChannels[Symbol.iterator]();!(t=(r=o.next()).done);t=!0){var a=r.value;if(e===a.id)return a}}catch(e){n=!0,i=e}finally{try{!t&&o.return&&o.return()}finally{if(n)throw i}}return null}},{key:"addWebChannel",value:function(e){this.webChannels[this.webChannels.length]=e}},{key:"removeWebChannel",value:function(e){this.webChannels.splice(this.webChannels.indexOf(e),1)}}]),e}();e.create=t,e.BotServer=ke,e.WEB_SOCKET=ve,e.WEB_RTC=pe,Object.defineProperty(e,"__esModule",{value:!0})});
