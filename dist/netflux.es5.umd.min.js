!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n(e.netflux=e.netflux||{})}(this,function(e){"use strict";function n(e){var n={connector:se,topology:de,signalingURL:"wss://sigver-coastteam.rhcloud.com:8443",iceServers:[{urls:"stun:turn01.uswest.xirsys.com"}],listenOn:""},t=Object.assign({},n,e);return new B(t)}var t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i=(function(){function e(e){this.value=e}function n(n){function t(e,n){return new Promise(function(t,r){var s={key:e,arg:n,resolve:t,reject:r,next:null};a?a=a.next=s:(o=a=s,i(e,n))})}function i(t,o){try{var a=n[t](o),s=a.value;s instanceof e?Promise.resolve(s.value).then(function(e){i("next",e)},function(e){i("throw",e)}):r(a.done?"return":"normal",a.value)}catch(e){r("throw",e)}}function r(e,n){switch(e){case"return":o.resolve({value:n,done:!0});break;case"throw":o.reject(n);break;default:o.resolve({value:n,done:!1})}o=o.next,o?i(o.key,o.arg):a=null}var o,a;this._invoke=t,"function"!=typeof n.return&&(this.return=void 0)}return"function"==typeof Symbol&&Symbol.asyncIterator&&(n.prototype[Symbol.asyncIterator]=function(){return this}),n.prototype.next=function(e){return this._invoke("next",e)},n.prototype.throw=function(e){return this._invoke("throw",e)},n.prototype.return=function(e){return this._invoke("return",e)},{wrap:function(e){return function(){return new n(e.apply(this,arguments))}},await:function(n){return new e(n)}}}(),function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}),r=function(){function e(e,n){for(var t=0;t<n.length;t++){var i=n[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(n,t,i){return t&&e(n.prototype,t),i&&e(n,i),n}}(),o=function e(n,t,i){null===n&&(n=Function.prototype);var r=Object.getOwnPropertyDescriptor(n,t);if(void 0===r){var o=Object.getPrototypeOf(n);return null===o?void 0:e(o,t,i)}if("value"in r)return r.value;var a=r.get;if(void 0!==a)return a.call(i)},a=function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)},s=function(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n},c=6e4,u=new Map,d=new Map,l=function(){function e(n){i(this,e),this.id=n,u.has(this.id)||u.set(this.id,new WeakMap),d.has(this.id)||d.set(this.id,new WeakMap)}return r(e,[{key:"setPendingRequest",value:function(e,n,t){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:c;this.setTo(d,e,n,t),setTimeout(function(){t.reject("Pending request timeout")},i)}},{key:"getPendingRequest",value:function(e,n){return this.getFrom(d,e,n)}},{key:"setItem",value:function(e,n,t){this.setTo(u,e,n,t)}},{key:"getItem",value:function(e,n){return this.getFrom(u,e,n)}},{key:"getItems",value:function(e){var n=u.get(this.id).get(e);return n?n:new Map}},{key:"removeItem",value:function(e,n){var t=u.get(this.id),i=t.get(e);t.get(e).delete(n),0===i.size&&t.delete(e)}},{key:"getFrom",value:function(e,n,t){var i=e.get(this.id).get(n);if(void 0!==i){var r=i.get(t);if(void 0!==r)return r}return null}},{key:"setTo",value:function(e,n,t,i){var r=e.get(this.id),o=void 0;r.has(n)?o=r.get(n):(o=new Map,r.set(n,o)),o.has(t)||o.set(t,i)}}]),e}(),h=function(e){function n(){return i(this,n),s(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments))}return a(n,e),r(n,[{key:"connectTo",value:function(e,n){var t=this,i=[];return 0===n.length?Promise.resolve(i):new Promise(function(r,o){var a=0,s=fe.get(ue);n.forEach(function(o){s.connectTo(e,o).then(function(e){return t.onChannel(e)}).then(function(){++a===n.length&&r(i)}).catch(function(e){i.push({id:o,reason:e}),++a===n.length&&r(i)})})})}},{key:"add",value:function(e){throw new Error("Must be implemented by subclass!")}},{key:"broadcast",value:function(e,n){throw new Error("Must be implemented by subclass!")}},{key:"sendTo",value:function(e,n,t){throw new Error("Must be implemented by subclass!")}},{key:"leave",value:function(e){throw new Error("Must be implemented by subclass!")}}]),n}(l),f=1,p=2,v=3,y=4,g=5,m=function(e){function n(){return i(this,n),s(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments))}return a(n,e),r(n,[{key:"add",value:function(e){var t=this,i=e.webChannel,r=i.members.slice(),a=!0,s=!1,c=void 0;try{for(var u,d=o(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"getItems",this).call(this,i).keys()[Symbol.iterator]();!(a=(u=d.next()).done);a=!0){var l=u.value;r[r.length]=l}}catch(e){s=!0,c=e}finally{try{!a&&d.return&&d.return()}finally{if(s)throw c}}return this.setJP(i,e.peerId,e),i.sendInner(this.id,{code:f,jpId:e.peerId}),i.sendInnerTo(e,this.id,{code:p,peers:r}),new Promise(function(r,a){o(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"setPendingRequest",t).call(t,i,e.peerId,{resolve:r,reject:a})})}},{key:"broadcast",value:function(e,n){var t=!0,i=!1,r=void 0;try{for(var o,a=e.channels[Symbol.iterator]();!(t=(o=a.next()).done);t=!0){var s=o.value;s.send(n)}}catch(e){i=!0,r=e}finally{try{!t&&a.return&&a.return()}finally{if(i)throw r}}}},{key:"sendTo",value:function(e,n,t){var i=!0,r=!1,o=void 0;try{for(var a,s=n.channels[Symbol.iterator]();!(i=(a=s.next()).done);i=!0){var c=a.value;if(c.peerId===e)return void c.send(t)}}catch(e){r=!0,o=e}finally{try{!i&&s.return&&s.return()}finally{if(r)throw o}}}},{key:"sendInnerTo",value:function(e,t,i){if(e===t.myId)t.onChannelMessage(null,i);else{var r=o(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"getItem",this).call(this,t,t.myId);null===r&&(r=o(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"getItem",this).call(this,t,e)),null!==r?r.channel.send(i):t.members.includes(e)?this.sendTo(e,t,i):this.sendTo(t.members[0],t,i)}}},{key:"sendInner",value:function(e,t){var i=o(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"getItem",this).call(this,e,e.myId);null===i?this.broadcast(e,t):i.channel.send(t)}},{key:"leave",value:function(e){var n=!0,t=!1,i=void 0;try{for(var r,o=e.channels[Symbol.iterator]();!(n=(r=o.next()).done);n=!0){var a=r.value;a.clearHandlers(),a.close()}}catch(e){t=!0,i=e}finally{try{!n&&o.return&&o.return()}finally{if(t)throw i}}e.channels.clear()}},{key:"onChannel",value:function(e){var t=this;return new Promise(function(i,r){o(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"setPendingRequest",t).call(t,e.webChannel,e.peerId,{resolve:i,reject:r}),e.webChannel.sendInnerTo(e,t.id,{code:y})})}},{key:"onChannelClose",value:function(e,t){var i=t.webChannel,r=!0,a=!1,s=void 0;try{for(var c,u=i.channels[Symbol.iterator]();!(r=(c=u.next()).done);r=!0){var d=c.value;if(d.peerId===t.peerId)return i.channels.delete(d)}}catch(e){a=!0,s=e}finally{try{!r&&u.return&&u.return()}finally{if(a)throw s}}var l=o(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"getItems",this).call(this,i);return l.forEach(function(e){return e.channels.delete(t)}),!1}},{key:"onChannelError",value:function(e,n){console.error("Channel error with id: "+n.peerId+": ",e)}},{key:"onMessage",value:function(e,t,i,r){var a=this,s=e.webChannel,c=void 0;switch(r.code){case p:c=this.setJP(s,s.myId,e),c.channels.add(e),o(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"connectTo",this).call(this,s,r.peers).then(function(e){var t={code:v};c.channels.forEach(function(e){s.sendInnerTo(e,a.id,t),s.channels.add(e),s.onPeerJoin$(e.peerId)}),o(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"removeItem",a).call(a,s,s.myId),o(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"getItems",a).call(a,s).forEach(function(e){return s.sendInnerTo(e.channel,a.id,t)}),s.onJoin()});break;case v:if(c=o(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"getItem",this).call(this,s,s.myId),o(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"removeItem",this).call(this,s,t),null!==c)c.channels.add(e);else{s.channels.add(e),s.onPeerJoin$(t);var u=o(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"getPendingRequest",this).call(this,s,t);null!==u&&u.resolve(t)}break;case y:this.setJP(s,t,e);var d=null!==o(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"getItem",this).call(this,s,s.myId);s.sendInnerTo(e,this.id,{code:g,isJoining:d});break;case g:r.isJoining?this.setJP(s,t,e):o(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"getItem",this).call(this,s,s.myId).channels.add(e),o(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"getPendingRequest",this).call(this,s,t).resolve();break;case f:this.setJP(s,r.jpId,e)}}},{key:"setJP",value:function(e,t,i){var r=o(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"getItem",this).call(this,e,t);return r?r.channel=i:(r=new w(i),o(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"setItem",this).call(this,e,t,r)),r}}]),n}(h),w=function e(n,t){i(this,e),this.channel=n,this.channels=new Set};!function e(n,t,i){function r(a,s){if(!t[a]){if(!n[a]){var c="function"==typeof require&&require;if(!s&&c)return c(a,!0);if(o)return o(a,!0);var u=new Error("Cannot find module '"+a+"'");throw u.code="MODULE_NOT_FOUND",u}var d=t[a]={exports:{}};n[a][0].call(d.exports,function(e){var t=n[a][1][e];return r(t?t:e)},d,d.exports,e,n,t,i)}return t[a].exports}for(var o="function"==typeof require&&require,a=0;a<i.length;a++)r(i[a]);return r}({1:[function(e,n,t){},{}],2:[function(e,n,t){!function(){var t=e("./utils").log,i=e("./utils").browserDetails;n.exports.browserDetails=i,n.exports.extractVersion=e("./utils").extractVersion,n.exports.disableLog=e("./utils").disableLog;var r=e("./chrome/chrome_shim")||null,o=e("./edge/edge_shim")||null,a=e("./firefox/firefox_shim")||null,s=e("./safari/safari_shim")||null;switch(i.browser){case"opera":case"chrome":if(!r||!r.shimPeerConnection)return void t("Chrome shim is not included in this adapter release.");t("adapter.js shimming chrome."),n.exports.browserShim=r,r.shimGetUserMedia(),r.shimMediaStream(),r.shimSourceObject(),r.shimPeerConnection(),r.shimOnTrack();break;case"firefox":if(!a||!a.shimPeerConnection)return void t("Firefox shim is not included in this adapter release.");t("adapter.js shimming firefox."),n.exports.browserShim=a,a.shimGetUserMedia(),a.shimSourceObject(),a.shimPeerConnection(),a.shimOnTrack();break;case"edge":if(!o||!o.shimPeerConnection)return void t("MS edge shim is not included in this adapter release.");t("adapter.js shimming edge."),n.exports.browserShim=o,o.shimGetUserMedia(),o.shimPeerConnection();break;case"safari":if(!s)return void t("Safari shim is not included in this adapter release.");t("adapter.js shimming safari."),n.exports.browserShim=s,s.shimGetUserMedia();break;default:t("Unsupported browser!")}}()},{"./chrome/chrome_shim":3,"./edge/edge_shim":1,"./firefox/firefox_shim":5,"./safari/safari_shim":7,"./utils":8}],3:[function(e,n,i){var r=e("../utils.js").log,o=e("../utils.js").browserDetails,a={shimMediaStream:function(){window.MediaStream=window.MediaStream||window.webkitMediaStream},shimOnTrack:function(){"object"!=("undefined"==typeof window?"undefined":t(window))||!window.RTCPeerConnection||"ontrack"in window.RTCPeerConnection.prototype||Object.defineProperty(window.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){var n=this;this._ontrack&&(this.removeEventListener("track",this._ontrack),this.removeEventListener("addstream",this._ontrackpoly)),this.addEventListener("track",this._ontrack=e),this.addEventListener("addstream",this._ontrackpoly=function(e){e.stream.addEventListener("addtrack",function(t){var i=new Event("track");i.track=t.track,i.receiver={track:t.track},i.streams=[e.stream],n.dispatchEvent(i)}),e.stream.getTracks().forEach(function(n){var t=new Event("track");t.track=n,t.receiver={track:n},t.streams=[e.stream],this.dispatchEvent(t)}.bind(this))}.bind(this))}})},shimSourceObject:function(){"object"==("undefined"==typeof window?"undefined":t(window))&&(!window.HTMLMediaElement||"srcObject"in window.HTMLMediaElement.prototype||Object.defineProperty(window.HTMLMediaElement.prototype,"srcObject",{get:function(){return this._srcObject},set:function(e){var n=this;return this._srcObject=e,this.src&&URL.revokeObjectURL(this.src),e?(this.src=URL.createObjectURL(e),e.addEventListener("addtrack",function(){n.src&&URL.revokeObjectURL(n.src),n.src=URL.createObjectURL(e)}),void e.addEventListener("removetrack",function(){n.src&&URL.revokeObjectURL(n.src),n.src=URL.createObjectURL(e)})):void(this.src="")}}))},shimPeerConnection:function(){window.RTCPeerConnection=function(e,n){r("PeerConnection"),e&&e.iceTransportPolicy&&(e.iceTransports=e.iceTransportPolicy);var i=new webkitRTCPeerConnection(e,n),o=i.getStats.bind(i);return i.getStats=function(e,n,i){var r=this,a=arguments;if(arguments.length>0&&"function"==typeof e)return o(e,n);var s=function(e){var n={},t=e.result();return t.forEach(function(e){var t={id:e.id,timestamp:e.timestamp,type:e.type};e.names().forEach(function(n){t[n]=e.stat(n)}),n[t.id]=t}),n},c=function(e,n){var t=new Map(Object.keys(e).map(function(n){return[n,e[n]]}));return n=n||e,Object.keys(n).forEach(function(e){t[e]=n[e]}),t};if(arguments.length>=2){var u=function(e){a[1](c(s(e)))};return o.apply(this,[u,arguments[0]])}return new Promise(function(n,i){1===a.length&&"object"==("undefined"==typeof e?"undefined":t(e))?o.apply(r,[function(e){n(c(s(e)))},i]):o.apply(r,[function(e){n(c(s(e),e.result()))},i])}).then(n,i)},i},window.RTCPeerConnection.prototype=webkitRTCPeerConnection.prototype,webkitRTCPeerConnection.generateCertificate&&Object.defineProperty(window.RTCPeerConnection,"generateCertificate",{get:function(){return webkitRTCPeerConnection.generateCertificate}}),["createOffer","createAnswer"].forEach(function(e){var n=webkitRTCPeerConnection.prototype[e];webkitRTCPeerConnection.prototype[e]=function(){var e=this;if(arguments.length<1||1===arguments.length&&"object"==t(arguments[0])){var i=1===arguments.length?arguments[0]:void 0;return new Promise(function(t,r){n.apply(e,[t,r,i])})}return n.apply(this,arguments)}}),o.version<51&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(e){var n=webkitRTCPeerConnection.prototype[e];webkitRTCPeerConnection.prototype[e]=function(){var e=arguments,t=this,i=new Promise(function(i,r){n.apply(t,[e[0],i,r])});return e.length<2?i:i.then(function(){e[1].apply(null,[])},function(n){e.length>=3&&e[2].apply(null,[n])})}}),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(e){var n=webkitRTCPeerConnection.prototype[e];webkitRTCPeerConnection.prototype[e]=function(){return arguments[0]=new("addIceCandidate"===e?RTCIceCandidate:RTCSessionDescription)(arguments[0]),n.apply(this,arguments)}});var e=RTCPeerConnection.prototype.addIceCandidate;RTCPeerConnection.prototype.addIceCandidate=function(){return null===arguments[0]?(arguments[1]&&arguments[1].apply(null),Promise.resolve()):e.apply(this,arguments)}}};n.exports={shimMediaStream:a.shimMediaStream,shimOnTrack:a.shimOnTrack,shimSourceObject:a.shimSourceObject,shimPeerConnection:a.shimPeerConnection,shimGetUserMedia:e("./getusermedia")}},{"../utils.js":8,"./getusermedia":4}],4:[function(e,n,i){var r=e("../utils.js").log;n.exports=function(){var e=function(e){if("object"!=("undefined"==typeof e?"undefined":t(e))||e.mandatory||e.optional)return e;var n={};return Object.keys(e).forEach(function(i){if("require"!==i&&"advanced"!==i&&"mediaSource"!==i){var r="object"==t(e[i])?e[i]:{ideal:e[i]};void 0!==r.exact&&"number"==typeof r.exact&&(r.min=r.max=r.exact);var o=function(e,n){return e?e+n.charAt(0).toUpperCase()+n.slice(1):"deviceId"===n?"sourceId":n};if(void 0!==r.ideal){n.optional=n.optional||[];var a={};"number"==typeof r.ideal?(a[o("min",i)]=r.ideal,n.optional.push(a),a={},a[o("max",i)]=r.ideal,n.optional.push(a)):(a[o("",i)]=r.ideal,n.optional.push(a))}void 0!==r.exact&&"number"!=typeof r.exact?(n.mandatory=n.mandatory||{},n.mandatory[o("",i)]=r.exact):["min","max"].forEach(function(e){void 0!==r[e]&&(n.mandatory=n.mandatory||{},n.mandatory[o(e,i)]=r[e])})}}),e.advanced&&(n.optional=(n.optional||[]).concat(e.advanced)),n},n=function(n,i){if(n=JSON.parse(JSON.stringify(n)),n&&n.audio&&(n.audio=e(n.audio)),n&&"object"==t(n.video)){var o=n.video.facingMode;if(o=o&&("object"==("undefined"==typeof o?"undefined":t(o))?o:{ideal:o}),o&&("user"===o.exact||"environment"===o.exact||"user"===o.ideal||"environment"===o.ideal)&&(!navigator.mediaDevices.getSupportedConstraints||!navigator.mediaDevices.getSupportedConstraints().facingMode)&&(delete n.video.facingMode,"environment"===o.exact||"environment"===o.ideal))return navigator.mediaDevices.enumerateDevices().then(function(t){t=t.filter(function(e){return"videoinput"===e.kind});var a=t.find(function(e){return e.label.toLowerCase().indexOf("back")!==-1})||t.length&&t[t.length-1];return a&&(n.video.deviceId=o.exact?{exact:a.deviceId}:{ideal:a.deviceId}),n.video=e(n.video),r("chrome: "+JSON.stringify(n)),i(n)});n.video=e(n.video)}return r("chrome: "+JSON.stringify(n)),i(n)},i=function(e){return{name:{PermissionDeniedError:"NotAllowedError",ConstraintNotSatisfiedError:"OverconstrainedError"}[e.name]||e.name,message:e.message,constraint:e.constraintName,toString:function(){return this.name+(this.message&&": ")+this.message}}},o=function(e,t,r){n(e,function(e){navigator.webkitGetUserMedia(e,t,function(e){r(i(e))})})};navigator.getUserMedia=o;var a=function(e){return new Promise(function(n,t){navigator.getUserMedia(e,n,t)})};if(navigator.mediaDevices||(navigator.mediaDevices={getUserMedia:a,enumerateDevices:function(){return new Promise(function(e){var n={audio:"audioinput",video:"videoinput"};return MediaStreamTrack.getSources(function(t){e(t.map(function(e){return{label:e.label,kind:n[e.kind],deviceId:e.id,groupId:""}}))})})}}),navigator.mediaDevices.getUserMedia){var s=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(e){return n(e,function(e){return s(e).then(function(n){if(e.audio&&!n.getAudioTracks().length||e.video&&!n.getVideoTracks().length)throw n.getTracks().forEach(function(e){e.stop()}),new DOMException("","NotFoundError");return n},function(e){return Promise.reject(i(e))})})}}else navigator.mediaDevices.getUserMedia=function(e){return a(e)};"undefined"==typeof navigator.mediaDevices.addEventListener&&(navigator.mediaDevices.addEventListener=function(){r("Dummy mediaDevices.addEventListener called.")}),"undefined"==typeof navigator.mediaDevices.removeEventListener&&(navigator.mediaDevices.removeEventListener=function(){r("Dummy mediaDevices.removeEventListener called.")})}},{"../utils.js":8}],5:[function(e,n,i){var r=e("../utils").browserDetails,o={shimOnTrack:function(){"object"!=("undefined"==typeof window?"undefined":t(window))||!window.RTCPeerConnection||"ontrack"in window.RTCPeerConnection.prototype||Object.defineProperty(window.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){this._ontrack&&(this.removeEventListener("track",this._ontrack),this.removeEventListener("addstream",this._ontrackpoly)),this.addEventListener("track",this._ontrack=e),this.addEventListener("addstream",this._ontrackpoly=function(e){e.stream.getTracks().forEach(function(n){var t=new Event("track");t.track=n,t.receiver={track:n},t.streams=[e.stream],this.dispatchEvent(t)}.bind(this))}.bind(this))}})},shimSourceObject:function(){"object"==("undefined"==typeof window?"undefined":t(window))&&(!window.HTMLMediaElement||"srcObject"in window.HTMLMediaElement.prototype||Object.defineProperty(window.HTMLMediaElement.prototype,"srcObject",{get:function(){return this.mozSrcObject},set:function(e){this.mozSrcObject=e}}))},shimPeerConnection:function(){if("object"==("undefined"==typeof window?"undefined":t(window))&&(window.RTCPeerConnection||window.mozRTCPeerConnection)){window.RTCPeerConnection||(window.RTCPeerConnection=function(e,n){if(r.version<38&&e&&e.iceServers){for(var t=[],i=0;i<e.iceServers.length;i++){var o=e.iceServers[i];if(o.hasOwnProperty("urls"))for(var a=0;a<o.urls.length;a++){var s={url:o.urls[a]};0===o.urls[a].indexOf("turn")&&(s.username=o.username,s.credential=o.credential),t.push(s)}else t.push(e.iceServers[i])}e.iceServers=t}return new mozRTCPeerConnection(e,n)},window.RTCPeerConnection.prototype=mozRTCPeerConnection.prototype,mozRTCPeerConnection.generateCertificate&&Object.defineProperty(window.RTCPeerConnection,"generateCertificate",{get:function(){return mozRTCPeerConnection.generateCertificate}}),window.RTCSessionDescription=mozRTCSessionDescription,window.RTCIceCandidate=mozRTCIceCandidate),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(e){var n=RTCPeerConnection.prototype[e];RTCPeerConnection.prototype[e]=function(){return arguments[0]=new("addIceCandidate"===e?RTCIceCandidate:RTCSessionDescription)(arguments[0]),n.apply(this,arguments)}});var e=RTCPeerConnection.prototype.addIceCandidate;RTCPeerConnection.prototype.addIceCandidate=function(){return null===arguments[0]?(arguments[1]&&arguments[1].apply(null),Promise.resolve()):e.apply(this,arguments)};var n=function(e){var n=new Map;return Object.keys(e).forEach(function(t){n.set(t,e[t]),n[t]=e[t]}),n},i=RTCPeerConnection.prototype.getStats;RTCPeerConnection.prototype.getStats=function(e,t,r){return i.apply(this,[e||null]).then(function(e){return n(e)}).then(t,r)}}}};n.exports={shimOnTrack:o.shimOnTrack,shimSourceObject:o.shimSourceObject,shimPeerConnection:o.shimPeerConnection,shimGetUserMedia:e("./getusermedia")}},{"../utils":8,"./getusermedia":6}],6:[function(e,n,i){var r=e("../utils").log,o=e("../utils").browserDetails;n.exports=function(){var e=function(e){return{name:{SecurityError:"NotAllowedError",PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:{"The operation is insecure.":"The request is not allowed by the user agent or the platform in the current context."}[e.message]||e.message,constraint:e.constraint,toString:function(){return this.name+(this.message&&": ")+this.message}}},n=function(n,i,a){var s=function(e){if("object"!=("undefined"==typeof e?"undefined":t(e))||e.require)return e;var n=[];return Object.keys(e).forEach(function(i){if("require"!==i&&"advanced"!==i&&"mediaSource"!==i){var r=e[i]="object"==t(e[i])?e[i]:{ideal:e[i]};if(void 0===r.min&&void 0===r.max&&void 0===r.exact||n.push(i),void 0!==r.exact&&("number"==typeof r.exact?r.min=r.max=r.exact:e[i]=r.exact,delete r.exact),void 0!==r.ideal){e.advanced=e.advanced||[];var o={};"number"==typeof r.ideal?o[i]={min:r.ideal,max:r.ideal}:o[i]=r.ideal,e.advanced.push(o),delete r.ideal,Object.keys(r).length||delete e[i]}}}),n.length&&(e.require=n),e};return n=JSON.parse(JSON.stringify(n)),o.version<38&&(r("spec: "+JSON.stringify(n)),n.audio&&(n.audio=s(n.audio)),n.video&&(n.video=s(n.video)),r("ff37: "+JSON.stringify(n))),navigator.mozGetUserMedia(n,i,function(n){a(e(n))})},i=function(e){return new Promise(function(t,i){n(e,t,i)})};if(navigator.mediaDevices||(navigator.mediaDevices={getUserMedia:i,addEventListener:function(){},removeEventListener:function(){}}),navigator.mediaDevices.enumerateDevices=navigator.mediaDevices.enumerateDevices||function(){return new Promise(function(e){var n=[{kind:"audioinput",deviceId:"default",label:"",groupId:""},{kind:"videoinput",deviceId:"default",label:"",groupId:""}];e(n)})},o.version<41){var a=navigator.mediaDevices.enumerateDevices.bind(navigator.mediaDevices);navigator.mediaDevices.enumerateDevices=function(){return a().then(void 0,function(e){if("NotFoundError"===e.name)return[];throw e})}}if(o.version<49){var s=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(n){return s(n).then(function(e){if(n.audio&&!e.getAudioTracks().length||n.video&&!e.getVideoTracks().length)throw e.getTracks().forEach(function(e){e.stop()}),new DOMException("The object can not be found here.","NotFoundError");return e},function(n){return Promise.reject(e(n))})}}navigator.getUserMedia=function(e,t,i){return o.version<44?n(e,t,i):(console.warn("navigator.getUserMedia has been replaced by navigator.mediaDevices.getUserMedia"),void navigator.mediaDevices.getUserMedia(e).then(t,i))}}},{"../utils":8}],7:[function(e,n,t){var i={shimGetUserMedia:function(){navigator.getUserMedia=navigator.webkitGetUserMedia}};n.exports={shimGetUserMedia:i.shimGetUserMedia}},{}],8:[function(e,n,i){var r=!0,o={disableLog:function(e){return"boolean"!=typeof e?new Error("Argument type: "+("undefined"==typeof e?"undefined":t(e))+". Please use a boolean."):(r=e,e?"adapter.js logging disabled":"adapter.js logging enabled")},log:function(){if("object"==("undefined"==typeof window?"undefined":t(window))){if(r)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}},extractVersion:function(e,n,t){var i=e.match(n);return i&&i.length>=t&&parseInt(i[t],10)},detectBrowser:function(){var e={};if(e.browser=null,e.version=null,"undefined"==typeof window||!window.navigator)return e.browser="Not a browser.",e;if(navigator.mozGetUserMedia)e.browser="firefox",e.version=this.extractVersion(navigator.userAgent,/Firefox\/([0-9]+)\./,1);else if(navigator.webkitGetUserMedia)if(window.webkitRTCPeerConnection)e.browser="chrome",e.version=this.extractVersion(navigator.userAgent,/Chrom(e|ium)\/([0-9]+)\./,2);else{if(!navigator.userAgent.match(/Version\/(\d+).(\d+)/))return e.browser="Unsupported webkit-based browser with GUM support but no WebRTC support.",e;e.browser="safari",e.version=this.extractVersion(navigator.userAgent,/AppleWebKit\/([0-9]+)\./,1)}else{if(!navigator.mediaDevices||!navigator.userAgent.match(/Edge\/(\d+).(\d+)$/))return e.browser="Not a supported browser.",e;e.browser="edge",e.version=this.extractVersion(navigator.userAgent,/Edge\/(\d+).(\d+)$/,2)}return e}};n.exports={log:o.log,disableLog:o.disableLog,browserDetails:o.detectBrowser(),extractVersion:o.extractVersion}},{}]},{},[2]);var b=function e(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i(this,e),this.wasClean=n.wasClean,this.code=n.code,this.reason=n.reason},C=function(){function e(){i(this,e)}return r(e,null,[{key:"createCloseEvent",value:function(n){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],r={wasClean:i,code:n,reason:t};return e.isBrowser()?new CloseEvent("netfluxClose",r):new b(r)}},{key:"isBrowser",value:function(){return"undefined"!=typeof window&&("undefined"==typeof process||"node"!==process.title)}},{key:"isSocket",value:function(e){return"WebSocket"===e.constructor.name}},{key:"isURL",value:function(e){var n="^(?:(?:wss|ws)://)(?:\\S+(?::\\S*)?@)?(?:",t="(?:\\.(?:[a-z\\u00a1-\\uffff]{2,}))?";return n+="(?:[1-9]\\d?|1\\d\\d|2[01]\\d|22[0-3])(?:\\.(?:1?\\d{1,2}|2[0-4]\\d|25[0-5])){2}(?:\\.(?:[1-9]\\d?|1\\d\\d|2[0-4]\\d|25[0-4]))|(?:(?:[a-z\\u00a1-\\uffff0-9]-*)*[a-z\\u00a1-\\uffff0-9]+)(?:\\.(?:[a-z\\u00a1-\\uffff0-9]-*)*[a-z\\u00a1-\\uffff0-9]+)*"+t+")(?::\\d{2,5})?(?:[/?#]\\S*)?$",!!new RegExp(n,"i").exec(e)}},{key:"require",value:function(e){function n(n){return e.apply(this,arguments)}return n.toString=function(){return e.toString()},n}(function(e){try{return require(e)}catch(n){return void console.error(e+" could not be found: "+n)}})},{key:"requireLib",value:function(n){switch(n){case e.WEB_RTC_LIB:return e.isBrowser()?window:e.require("wrtc");case e.WEB_SOCKET_LIB:return e.isBrowser()?window.WebSocket:e.require("ws");case e.TEXT_ENCODING_LIB:return e.isBrowser()?window:e.require("text-encoding");default:return void console.error(n+" is unknown lib constant. See Util")}}},{key:"WEB_RTC_LIB",get:function(){return 1}},{key:"WEB_SOCKET_LIB",get:function(){return 2}},{key:"TEXT_ENCODING_LIB",get:function(){return 3}}]),e}(),O=C.requireLib(C.WEB_RTC_LIB),k=3e4,I=5e3,_=function(e){function n(e,t){i(this,n);var r=s(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e));return r.iceServers=t,r}return a(n,e),r(n,[{key:"onMessage",value:function(e,t,i,r){var a=this,s=e.webChannel,c=o(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"getItem",this).call(this,s,t);c||(c=new S,o(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"setItem",this).call(this,s,t,c)),"offer"in r&&(c.pc=this.createPeerConnection(function(e){s.sendInnerTo(t,a.id,{candidate:e})}),this.listenOnDataChannel(c.pc,function(e){setTimeout(function(){return o(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"removeItem",a).call(a,s,t)},I),fe.get(ue).onChannel(s,e,t)}),this.createAnswer(c.pc,r.offer,c.candidates).then(function(e){return s.sendInnerTo(t,a.id,{answer:e})}).catch(function(e){return console.error("During Establishing dataChannel connection over webChannel: "+e.message)})),"answer"in r?c.pc.setRemoteDescription(r.answer).then(function(){return c.pc.addReceivedCandidates(c.candidates)}).catch(function(e){return console.error("Set answer (webChannel): "+e.message)}):"candidate"in r&&this.addIceCandidate(c,r.candidate)}},{key:"connectOverWebChannel",value:function(e,t){var i=this,r=new S(this.createPeerConnection(function(n){e.sendInnerTo(t,i.id,{candidate:n})}));return o(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"setItem",this).call(this,e,t,r),new Promise(function(a,s){setTimeout(s,k,"WebRTC connect timeout"),i.createDataChannel(r.pc,function(r){setTimeout(function(){return o(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"removeItem",i).call(i,e,t)},I),a(r)}),i.createOffer(r.pc).then(function(n){return e.sendInnerTo(t,i.id,{offer:n})}).catch(s)})}},{key:"listenFromSignaling",value:function(e,t){var i=this;e.onmessage=function(r){var a=JSON.parse(r.data);if("id"in a&&"data"in a){var s=o(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"getItem",i).call(i,e,a.id);s||(s=new S(i.createPeerConnection(function(n){1===e.readyState&&e.send(JSON.stringify({id:a.id,data:{candidate:n}}))})),o(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"setItem",i).call(i,e,a.id,s)),"offer"in a.data?(i.listenOnDataChannel(s.pc,function(r){setTimeout(function(){return o(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"removeItem",i).call(i,e,a.id)},I),t(r)}),i.createAnswer(s.pc,a.data.offer,s.candidates).then(function(n){e.send(JSON.stringify({id:a.id,data:{answer:n}}))}).catch(function(e){console.error("During establishing data channel connection through signaling: "+e.message)})):"candidate"in a.data&&i.addIceCandidate(s,a.data.candidate)}}}},{key:"connectOverSignaling",value:function(e,t){var i=this,r=new S(this.createPeerConnection(function(n){1===e.readyState&&e.send(JSON.stringify({data:{candidate:n}}))}));return o(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"setItem",this).call(this,e,t,r),new Promise(function(a,s){e.onclose=function(e){return s(e.reason)},e.onmessage=function(a){try{var c=JSON.parse(a.data);"data"in c&&("answer"in c.data?r.pc.setRemoteDescription(c.data.answer).then(function(){return r.pc.addReceivedCandidates(r.candidates)}).catch(function(e){return s("Set answer (signaling): "+e.message)}):"candidate"in c.data&&i.addIceCandidate(o(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"getItem",i).call(i,e,t),c.data.candidate))}catch(n){s("Unknown message from the server "+e.url+": "+a.data)}},i.createDataChannel(r.pc,function(r){setTimeout(function(){return o(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"removeItem",i).call(i,e,t)},I),a(r)}),
i.createOffer(r.pc).then(function(n){return e.send(JSON.stringify({data:{offer:n}}))}).catch(s)})}},{key:"createOffer",value:function(e){return e.createOffer().then(function(n){return e.setLocalDescription(n)}).then(function(){return{type:e.localDescription.type,sdp:e.localDescription.sdp}})}},{key:"createAnswer",value:function(e,n,t){return e.setRemoteDescription(n).then(function(){return e.addReceivedCandidates(t),e.createAnswer()}).then(function(n){return e.setLocalDescription(n)}).then(function(){return{type:e.localDescription.type,sdp:e.localDescription.sdp}})}},{key:"createPeerConnection",value:function(e){var n=this,t=new O.RTCPeerConnection({iceServers:this.iceServers});return t.isRemoteDescriptionSet=!1,t.addReceivedCandidates=function(e){t.isRemoteDescriptionSet=!0;var i=!0,r=!1,o=void 0;try{for(var a,s=e[Symbol.iterator]();!(i=(a=s.next()).done);i=!0){var c=a.value;n.addIceCandidate({pc:t},c)}}catch(e){r=!0,o=e}finally{try{!i&&s.return&&s.return()}finally{if(r)throw o}}},t.onicecandidate=function(n){if(null!==n.candidate){var t={candidate:n.candidate.candidate,sdpMid:n.candidate.sdpMid,sdpMLineIndex:n.candidate.sdpMLineIndex};e(t)}},t}},{key:"createDataChannel",value:function(e,n){var t=e.createDataChannel(null);t.onopen=function(e){return n(t)},this.setUpOnDisconnect(e,t)}},{key:"listenOnDataChannel",value:function(e,n){var t=this;e.ondatachannel=function(i){t.setUpOnDisconnect(e,i.channel),i.channel.onopen=function(e){return n(i.channel)}}}},{key:"setUpOnDisconnect",value:function(e,n){e.oniceconnectionstatechange=function(){"disconnected"===e.iceConnectionState&&n.onclose&&n.onclose(C.createCloseEvent(4201,"disconnected",!1))}}},{key:"addIceCandidate",value:function(e,n){null!==e&&e.pc&&e.pc.isRemoteDescriptionSet?e.pc.addIceCandidate(new O.RTCIceCandidate(n)).catch(function(e){return console.error("Add ICE candidate: "+e.message)}):e.candidates[e.candidates.length]=n}}]),n}(l),S=function e(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];i(this,e),this.pc=n,this.candidates=t},T=C.requireLib(C.WEB_SOCKET_LIB),P=1e4,E=function(e){function n(){return i(this,n),s(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments))}return a(n,e),r(n,[{key:"connect",value:function(e){return new Promise(function(n,t){try{!function(){var i=new T(e);i.onopen=function(){return n(i)},setTimeout(function(){i.readyState!==i.OPEN&&t("WebSocket connection timeout with "+e)},P)}()}catch(e){t(e.message)}})}}]),n}(l),j=function(e){function n(e){i(this,n);var t=s(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e));return t.WS=[ce],t.WR=[se],t.WS_WR=[ce,se],t.WR_WS=[se,ce],t}return a(n,e),r(n,[{key:"connectTo",value:function(e,t){var i=this;return new Promise(function(r,a){o(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"setPendingRequest",i).call(i,e,t,{resolve:r,reject:a}),e.sendInnerTo(t,i.id,i.availableConnectors(e))})}},{key:"availableConnectors",value:function(e){var n={},t=[];return void 0!==C.requireLib(C.WEB_RTC_LIB)&&(t[t.length]=se),""!==e.settings.listenOn&&(t[t.length]=ce,n.listenOn=e.settings.listenOn),2===t.length&&t[0]!==e.settings.connector&&t.reverse(),n.connectors=t,n}},{key:"onChannel",value:function(e,t,i){var r=this;e.initChannel(t,i).then(function(t){var a=o(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"getPendingRequest",r).call(r,e,i);null!==a&&a.resolve(t)})}},{key:"onMessage",value:function(e,t,i,r){var a=this,s=e.webChannel,c=this.availableConnectors(s),u=c.connectors;"failedReason"in r?o(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"getPendingRequest",this).call(this,s,t).reject(r.failedReason):"shouldConnect"in r?this.isEqual(r.shouldConnect,this.WS)?fe.get(ce).connect(r.listenOn).then(function(e){e.send(JSON.stringify({wcId:s.id,senderId:s.myId})),a.onChannel(s,e,t)}).catch(function(e){o(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"getPendingRequest",a).call(a,s,t).reject("Failed to establish a socket: "+e)}):this.isEqual(r.shouldConnect,this.WS_WR)&&fe.get(ce).connect(r.listenOn).then(function(e){e.send(JSON.stringify({wcId:s.id,senderId:s.myId})),a.onChannel(s,e,t)}).catch(function(e){return fe.get(se,s.settings.iceServers).connectOverWebChannel(s,t)}).then(function(e){return a.onChannel(s,e,t)}).catch(function(e){"feedbackOnFail"in r&&r.feedbackOnFail===!0?s.sendInnerTo(t,a.id,{tryOn:a.WS,listenOn:c.listenOn}):o(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"getPendingRequest",a).call(a,s,t).reject("Failed to establish a socket and then a data channel: "+e)}):"tryOn"in r&&this.isEqual(r.tryOn,this.WS)?fe.get(ce).connect(r.listenOn).then(function(e){e.send(JSON.stringify({wcId:s.id,senderId:s.myId})),a.onChannel(s,e,t)}).catch(function(e){return s.sendInnerTo(t,a.id,{failedReason:"Failed to establish a socket: "+e})}):"connectors"in r&&(this.isValid(r.connectors)?(0===r.connectors.length&&(0===u.length||this.isEqual(u,this.WS)?s.sendInnerTo(t,this.id,{failedReason:"No common connectors"}):s.sendInnerTo(t,this.id,{shouldConnect:this.WS,listenOn:c.listenOn})),this.isEqual(r.connectors,this.WS)&&(0===u.length||this.isEqual(u,this.WS)?this.ws(s,t,r.listenOn):this.wsWs(s,t,r.listenOn,c.listenOn)),this.isEqual(r.connectors,this.WR)&&(0===u.length?s.sendInnerTo(t,this.id,{failedReason:"No common connectors"}):this.isEqual(u,this.WS)?s.sendInnerTo(t,this.id,{shouldConnect:this.WS,listenOn:c.listenOn}):this.isEqual(u,this.WR)?fe.get(se,s.settings.iceServers).connectOverWebChannel(s,t).then(function(e){return a.onChannel(s,e,t)}).catch(function(e){s.sendInnerTo(t,a.id,{failedReason:"Failed establish a data channel: "+e})}):this.isEqual(u,this.WS_WR)?s.sendInnerTo(t,this.id,{shouldConnect:this.WS_WR,listenOn:c.listenOn}):this.isEqual(u,this.WR_WS)&&fe.get(se,s.settings.iceServers).connectOverWebChannel(s,t).then(function(e){return a.onChannel(s,e,t)}).catch(function(e){s.sendInnerTo(t,a.id,{shouldConnect:a.WS,listenOn:c.listenOn})})),this.isEqual(r.connectors,this.WS_WR)&&(0===u.length?this.ws(s,t,r.listenOn):this.isEqual(u,this.WS)?this.wsWs(s,t,r.listenOn,c.listenOn):this.isEqual(u,this.WR)?fe.get(ce).connect(r.listenOn).then(function(e){e.send(JSON.stringify({wcId:s.id,senderId:s.myId})),a.onChannel(s,e,t)}).catch(function(e){return fe.get(se,s.settings.iceServers).connectOverWebChannel(s,t)}).then(function(e){return a.onChannel(s,e,t)}).catch(function(e){return s.sendInnerTo(t,a.id,{failedReason:"Failed to establish a socket and then a data channel: "+e})}):this.isEqual(u,this.WS_WR)?fe.get(ce).connect(r.listenOn).then(function(e){e.send(JSON.stringify({wcId:s.id,senderId:s.myId})),a.onChannel(s,e,t)}):this.isEqual(u,this.WR_WS)?s.sendInnerTo(t,this.id,{shouldConnect:this.WS_WR,listenOn:c.listenOn}):fe.get(ce).connect(r.listenOn).then(function(e){e.send(JSON.stringify({wcId:s.id,senderId:s.myId})),a.onChannel(s,e,t)}).catch(function(e){return fe.get(se,s.settings.iceServers).connectOverWebChannel(s,t)}).then(function(e){return a.onChannel(s,e,t)}).catch(function(e){return s.sendInnerTo(t,a.id,{shouldConnect:a.WS,listenOn:c.listenOn})})),this.isEqual(r.connectors,this.WR_WS)&&(0===u.length?this.ws(s,t,r.listenOn):this.isEqual(u,this.WS)?this.wsWs(s,t,r.listenOn,c.listenOn):this.isEqual(u,this.WR)?fe.get(se,s.settings.iceServers).connectOverWebChannel(s,t).then(function(e){return a.onChannel(s,e,t)}).catch(function(e){return fe.get(ce).connect(r.listenOn)}).then(function(e){e.send(JSON.stringify({wcId:s.id,senderId:s.myId})),a.onChannel(s,e,t)}).catch(function(e){return s.sendInnerTo(t,a.id,{failedReason:"Failed to establish a data channel and then a socket: "+e})}):this.isEqual(u,this.WS_WR)?s.sendInnerTo(t,this.id,{shouldConnect:this.WS_WR,feedbackOnFail:!0,listenOn:c.listenOn}):this.isEqual(u,this.WR_WS)&&fe.get(se,s.settings.iceServers).connectOverWebChannel(s,t).then(function(e){return a.onChannel(s,e,t)}).catch(function(e){return fe.get(ce).connect(r.listenOn)}).then(function(e){e.send(JSON.stringify({wcId:s.id,senderId:s.myId})),a.onChannel(s,e,t)}).catch(function(e){return s.sendInnerTo(t,a.id,{shouldConnect:a.WS,listenOn:c.listenOn})}))):s.sendInnerTo(t,this.id,{failedReason:"Unknown connectors: "+r.connectors}))}},{key:"wsWs",value:function(e,n,t,i){var r=this;fe.get(ce).connect(t).then(function(t){t.send(JSON.stringify({wcId:e.id,senderId:e.myId})),r.onChannel(e,t,n)}).catch(function(t){e.sendInnerTo(n,r.id,{shouldConnect:r.WS,listenOn:i})})}},{key:"ws",value:function(e,n,t){var i=this;fe.get(ce).connect(t).then(function(t){t.send(JSON.stringify({wcId:e.id,senderId:e.myId})),i.onChannel(e,t,n)}).catch(function(t){e.sendInnerTo(n,i.id,{failedReason:"Failed to establish a socket: "+t})})}},{key:"isValid",value:function(e){return!!(this.isEqual(e,this.WS)||this.isEqual(e,this.WR)||this.isEqual(e,this.WS_WR)||this.isEqual(e,this.WR_WS))}},{key:"isEqual",value:function(e,n){if(e.length!==n.length)return!1;for(var t=0;t<e.length;t++)if(e[t]!==n[t])return!1;return!0}}]),n}(l),R=function(){function e(n,t,r){i(this,e),this.channel=n,this.webChannel=null,this.peerId=-1,this.send=null,C.isBrowser()?(n.binaryType="arraybuffer",this.send=this.sendBrowser):C.isSocket(n)?this.send=this.sendInNodeThroughSocket:(n.binaryType="arraybuffer",this.send=this.sendInNodeThroughDataChannel)}return r(e,[{key:"sendBrowser",value:function(e){if(this.isOpen())try{this.channel.send(e)}catch(e){console.error("Channel send: "+e.message)}}},{key:"sendInNodeThroughSocket",value:function(e){if(this.isOpen())try{this.channel.send(e,{binary:!0})}catch(e){console.error("Channel send: "+e.message)}}},{key:"sendInNodeThroughDataChannel",value:function(e){this.sendBrowser(e.slice(0))}},{key:"clearHandlers",value:function(){this.onMessage=function(){},this.onClose=function(){},this.onError=function(){}}},{key:"isOpen",value:function(){var e=this.channel.readyState;return 1===e||"open"===e}},{key:"close",value:function(){this.channel.close()}},{key:"onMessage",set:function(e){!C.isBrowser()&&C.isSocket(this.channel)?this.channel.onmessage=function(n){for(var t=new ArrayBuffer(n.data.length),i=new Uint8Array(t),r=0;r<n.data.length;r++)i[r]=n.data[r];e(t)}:this.channel.onmessage=function(n){return e(n.data)}}},{key:"onClose",set:function(e){var n=this;this.channel.onclose=function(t){null!==n.webChannel&&e(t)?(n.webChannel.members.splice(n.webChannel.members.indexOf(n.peerId),1),n.webChannel.onPeerLeave(n.peerId)):e(t)}}},{key:"onError",set:function(e){this.channel.onerror=function(n){return e(n)}}}]),e}(),U=function(){function e(n){i(this,e),this.webChannel=n,this.url=null,this.key=null,this.ws=null}return r(e,[{key:"open",value:function(e,n){var t=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return new Promise(function(r,o){null===i&&(i=t.generateKey()),fe.get(ce).connect(e).then(function(a){a.onclose=function(e){t.key=null,t.ws=null,t.url=null,t.webChannel.onClose(e),o(e.reason)},a.onerror=function(e){return o(e.message)},a.onmessage=function(s){try{var c=JSON.parse(s.data);"isKeyOk"in c?c.isKeyOk?(fe.get(se,t.webChannel.settings.iceServers).listenFromSignaling(a,n),t.ws=a,t.key=i,t.url=e,r({url:e,key:i})):o(i+" key already exists"):o("Unknown message from "+e+": "+s.data)}catch(e){o("Server responce is not a JSON string: "+e.message)}},a.send(JSON.stringify({key:i}))}).catch(o)})}},{key:"isOpen",value:function(){return null!==this.ws&&this.ws.readyState===this.ws.OPEN}},{key:"getOpenData",value:function(){return this.isOpen()?{url:this.url,key:this.key}:null}},{key:"close",value:function(){this.isOpen()&&this.ws.close()}},{key:"generateKey",value:function(){for(var e=5,n=0,t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",i="",r=e+Math.round(Math.random()*n),o=0;o<r;o++)i+=t[Math.round(Math.random()*(t.length-1))];return i}}]),e}(),x=4294967295,D=5e3,M=1e4,W=1,L=2,N=3,q=4,A=5,B=function(){function e(n){i(this,e),this.settings=n,this.channels=new Set,this.onJoin=function(){},this.manager=fe.get(this.settings.topology),this.msgBld=fe.get(le),this.members=[],this.generatedIds=new Set,this.pingTime=0,this.maxTime=0,this.pingFinish=function(){},this.pongNb=0,this.gate=new U(this),this.id=this.generateId(),this.myId=this.generateId(),this.onPeerJoin=function(){},this.onPeerLeave=function(){},this.onMessage=function(){},this.onClose=function(){}}return r(e,[{key:"join",value:function(e){var n=this,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.settings.signalingURL;return new Promise(function(i,r){n.onJoin=i,"WebSocket"!==e.constructor.name?C.isURL(t)?fe.get(ce).connect(t).then(function(i){i.onclose=function(e){return r(e.reason)},i.onmessage=function(o){try{var a=JSON.parse(o.data);"isKeyOk"in a?a.isKeyOk?"useThis"in a&&a.useThis?n.initChannel(i).catch(r):fe.get(se,n.settings.iceServers).connectOverSignaling(i,e).then(function(e){return i.onclose=null,i.close(),n.initChannel(e)}).catch(r):r('The key "'+e+'" was not found'):r("Unknown message from the server "+t+": "+o.data)}catch(e){r(e.message)}},i.send(JSON.stringify({join:e}))}).catch(r):r(t+" is not a valid URL"):n.initChannel(e).catch(r)})}},{key:"invite",value:function(e){var n=this;return"string"==typeof e||e instanceof String?C.isURL(e)?fe.get(ce).connect(e).then(function(e){return e.send(JSON.stringify({wcId:n.id})),n.addChannel(e)}):Promise.reject(e+" is not a valid URL"):"WebSocket"===e.constructor.name?this.addChannel(e):Promise.reject(e+" is not a valid URL")}},{key:"open",value:function(e){var n=this,t={url:this.settings.signalingURL,key:null},i=Object.assign({},t,e);return C.isURL(i.url)?this.gate.open(i.url,function(e){return n.addChannel(e)},i.key):Promise.reject(i.url+" is not a valid URL")}},{key:"close",value:function(){this.gate.close()}},{key:"isOpen",value:function(){return this.gate.isOpen()}},{key:"getOpenData",value:function(){return this.gate.getOpenData()}},{key:"leave",value:function(){0!==this.channels.size&&(this.members=[],this.pingTime=0,this.manager.leave(this))}},{key:"send",value:function(e){var n=this;0!==this.channels.size&&this.msgBld.handleUserMessage(e,this.myId,null,function(e){n.manager.broadcast(n,e)})}},{key:"sendTo",value:function(e,n){var t=this;0!==this.channels.size&&this.msgBld.handleUserMessage(n,this.myId,e,function(n){t.manager.sendTo(e,t,n)},!1)}},{key:"ping",value:function(){var e=this;return 0!==this.members.length&&0===this.pingTime?new Promise(function(n,t){0===e.pingTime&&(e.pingTime=Date.now(),e.maxTime=0,e.pongNb=0,e.pingFinish=function(e){return n(e)},e.manager.broadcast(e,e.msgBld.msg(q,e.myId)),setTimeout(function(){return n(D)},D))}):Promise.resolve(0)}},{key:"addChannel",value:function(e){var n=this;return this.initChannel(e).then(function(e){var t=n.msgBld.msg(N,n.myId,e.peerId,{manager:n.manager.id,wcId:n.id});return e.send(t),n.manager.add(e)})}},{key:"onPeerJoin$",value:function(e){this.members[this.members.length]=e,this.onPeerJoin(e)}},{key:"onPeerLeave$",value:function(e){this.members.splice(this.members.indexOf(e),1),this.onPeerLeave(e)}},{key:"sendInnerTo",value:function(e,n,t){var i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(i)this.manager.sendInnerTo(e,this,t);else if(Number.isInteger(e)){var r=this.msgBld.msg(L,this.myId,e,{serviceId:n,data:t});this.manager.sendInnerTo(e,this,r)}else e.send(this.msgBld.msg(L,this.myId,e.peerId,{serviceId:n,data:t}))}},{key:"sendInner",value:function(e,n){this.manager.sendInner(this,this.msgBld.msg(L,this.myId,null,{serviceId:e,data:n}))}},{key:"onChannelMessage",value:function(e,n){var t=this,i=this.msgBld.readHeader(n);if(i.code===W)this.msgBld.readUserMessage(this,i.senderId,n,function(e,n){t.onMessage(i.senderId,e,n)});else{var r=this.msgBld.readInternalMessage(n);switch(i.code){case N:this.settings.topology=r.manager,this.manager=fe.get(this.settings.topology),this.myId=i.recepientId,this.id=r.wcId,e.peerId=i.senderId;break;case L:0===i.recepientId||this.myId===i.recepientId?this.getService(r.serviceId).onMessage(e,i.senderId,i.recepientId,r.data):this.sendInnerTo(i.recepientId,null,n,!0);break;case q:this.manager.sendTo(i.senderId,this,this.msgBld.msg(A,this.myId));break;case A:var o=Date.now();this.pongNb++,this.maxTime=Math.max(this.maxTime,o-this.pingTime),this.pongNb===this.members.length&&(this.pingFinish(this.maxTime),this.pingTime=0);break;default:throw new Error('Unknown message type code: "'+i.code+'"')}}}},{key:"initChannel",value:function(e){var n=this,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1;t===-1&&(t=this.generateId());var i=new R(e);return i.peerId=t,i.webChannel=this,i.onMessage=function(e){return n.onChannelMessage(i,e)},i.onClose=function(e){return n.manager.onChannelClose(e,i)},i.onError=function(e){return n.manager.onChannelError(e,i)},Promise.resolve(i)}},{key:"getService",value:function(e){return e===se?fe.get(se,this.settings.iceServers):fe.get(e)}},{key:"generateId",value:function(){for(var e=this,n=function(){var n=Math.ceil(Math.random()*x);return n===e.myId?"continue":e.members.includes(n)?"continue":e.generatedIds.has(n)?"continue":(e.generatedIds.add(n),setTimeout(function(){return e.generatedIds.delete(n)},M),{v:n})};;){var i=n();switch(i){case"continue":continue;default:if("object"===("undefined"==typeof i?"undefined":t(i)))return i.v}}}}]),e}(),J=C.requireLib(C.TEXT_ENCODING_LIB),F=16365,z=19,G=9,V=65535,H=1,K=2,$=3,X=4,Q=5,Y=6,Z=7,ee=8,ne=9,te=10,ie=11,re=new WeakMap,oe=function(e){function n(){return i(this,n),s(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments))}return a(n,e),r(n,[{key:"handleUserMessage",value:function(e,n,t,i){var r=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],o=this.userDataToType(e),a=o.content;if(a.byteLength<=F){var s=this.initHeader(1,n,t,a.byteLength+z);s.setUint32(G,a.byteLength),s.setUint8(13,o.type),s.setUint8(14,r?1:0);var c=new Uint8Array(s.buffer);c.set(a,z),i(c.buffer)}else for(var u=Math.ceil(Math.random()*V),d=Math.ceil(a.byteLength/F),l=0;l<d;l++){var h=Math.min(F,a.byteLength-F*l),f=this.initHeader(W,n,t,z+h);f.setUint32(9,a.byteLength),f.setUint8(13,o.type),f.setUint8(14,r?1:0),f.setUint16(15,u),f.setUint16(17,l);for(var p=new Uint8Array(f.buffer),v=z,y=F*l,g=y+h,m=y;m<g;m++)p[v++]=a[m];i(p.buffer)}}},{key:"msg",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},r=(new J.TextEncoder).encode(JSON.stringify(i)),o=r.byteLength+G,a=this.initHeader(e,n,t,o),s=new Uint8Array(a.buffer);return s.set(r,G),s.buffer}},{key:"readUserMessage",value:function(e,n,t,i){var r=this,o=new DataView(t),a=o.getUint32(G),s=o.getUint8(13),c=o.getUint8(14);if(a>F){var u=o.getUint16(15),d=o.getUint16(17),l=this.getBuffer(e,n,u);void 0===l?this.setBuffer(e,n,u,new ae(a,t,d,function(e){i(r.extractUserData(e,s),c)})):l.add(t,d)}else{for(var h=new Uint8Array(t),f=new Uint8Array(t.byteLength-z),p=z,v=0;v<f.byteLength;v++)f[v]=h[p++];i(this.extractUserData(f.buffer,s),c)}}},{key:"readInternalMessage",value:function(e){var n=new Uint8Array(e);return JSON.parse((new J.TextDecoder).decode(n.subarray(G,n.byteLength)))}},{key:"readHeader",value:function(e){var n=new DataView(e);return{code:n.getUint8(0),senderId:n.getUint32(1),recepientId:n.getUint32(5)}}},{key:"initHeader",value:function(e,n,t,i){var r=new DataView(new ArrayBuffer(i));return r.setUint8(0,e),r.setUint32(1,n),r.setUint32(5,t),r}},{key:"extractUserData",value:function(e,n){switch(n){case H:return e;case K:return new Uint8Array(e);case $:return(new J.TextDecoder).decode(new Uint8Array(e));case X:return new Int8Array(e);case Q:return new Uint8ClampedArray(e);case Y:return new Int16Array(e);case Z:return new Uint16Array(e);case ee:return new Int32Array(e);case ne:return new Uint32Array(e);case te:return new Float32Array(e);case ie:return new Float64Array(e);default:throw new Error("Unknown type")}}},{key:"userDataToType",value:function(e){var n={};if(e instanceof ArrayBuffer)n.type=H,n.content=new Uint8Array(e);else if(e instanceof Uint8Array)n.type=K,n.content=e;else if("string"==typeof e||e instanceof String)n.type=$,n.content=(new J.TextEncoder).encode(e);else if(n.content=new Uint8Array(e.buffer),e instanceof Int8Array)n.type=X;else if(e instanceof Uint8ClampedArray)n.type=Q;else if(e instanceof Int16Array)n.type=Y;else if(e instanceof Uint16Array)n.type=Z;else if(e instanceof Int32Array)n.type=ee;else if(e instanceof Uint32Array)n.type=ne;else if(e instanceof Float32Array)n.type=te;else{if(!(e instanceof Float64Array))throw new Error("Unknown data object");n.type=ie}return n}},{key:"getBuffer",value:function(e,n,t){var i=re.get(e);if(void 0!==i){var r=i.get(n);if(void 0!==r)return r.get(t)}}},{key:"setBuffer",value:function(e,n,t,i){var r=re.get(e);void 0===r&&(r=new Map,re.set(e,r));var o=r.get(n);void 0===o&&(o=new Map,r.set(n,o)),o.set(t,i)}}]),n}(l),ae=function(){function e(n,t,r,o){i(this,e),this.fullData=new Uint8Array(n),this.currentSize=0,this.action=o,this.add(t,r)}return r(e,[{key:"add",value:function(e,n){var t=new Uint8Array(e),i=e.byteLength;this.currentSize+=i-z;for(var r=n*F,o=z;o<i;o++)this.fullData[r++]=t[o];this.currentSize===this.fullData.byteLength&&this.action(this.fullData.buffer)}}]),e}(),se=0,ce=1,ue=2,de=3,le=4,he=new Map,fe=function(){function e(){i(this,e)}return r(e,null,[{key:"get",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(he.has(e))return he.get(e);var t=void 0;switch(e){case se:return new _(se,n);case ce:return new E(ce);case ue:return new j(ue);case de:return t=new m(de),he.set(e,t),t;case le:return t=new oe(le),he.set(e,t),t;default:throw new Error(e+" is an Unknown service id")}}}]),e}(),pe=4e3,ve=4001,ye=function(){function e(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i(this,e),this.defaultSettings={connector:ce,topology:de,signalingURL:"wss://sigver-coastteam.rhcloud.com:8443",iceServers:[{urls:"stun:turn01.uswest.xirsys.com"}],host:"localhost",port:9e3},this.settings=Object.assign({},this.defaultSettings,n),this.settings.listenOn="ws://"+this.settings.host+":"+this.settings.port,this.server=null,this.webChannels=[],this.onWebChannel=function(){}}return r(e,[{key:"start",value:function(){var e=this;return new Promise(function(n,t){var i=C.require("ws").Server;e.server=new i({host:e.settings.host,port:e.settings.port},n);var r=!0,o=!1,a=void 0;try{for(var s,c=e.webChannels[Symbol.iterator]();!(r=(s=c.next()).done);r=!0){var u=s.value;u.settings.listenOn=e.settings.listenOn}}catch(e){o=!0,a=e}finally{try{!r&&c.return&&c.return()}finally{if(o)throw a}}e.server.on("error",function(n){console.error("Server error: ",n);var i=!0,r=!1,o=void 0;try{for(var a,s=e.webChannels[Symbol.iterator]();!(i=(a=s.next()).done);i=!0){var c=a.value;c.settings.listenOn=""}}catch(e){r=!0,o=e}finally{try{!i&&s.return&&s.return()}finally{if(r)throw o}}t("Server error: "+n.messsage)}),e.server.on("connection",function(n){n.onmessage=function(t){try{var i=JSON.parse(t.data);if("join"in i){var r=e.getWebChannel(i.join);null===r?n.send(JSON.stringify({isKeyOk:!1})):(n.send(JSON.stringify({isKeyOk:!0,useThis:!0})),r.invite(n))}else"wcId"in i&&!function(){var t=e.getWebChannel(i.wcId);"senderId"in i?null!==t?fe.get(ue).onChannel(t,n,i.senderId):(n.close(ve,i.wcId+" webChannel was not found (message received from "+i.senderId+")"),console.error(i.wcId+" webChannel was not found (message received from "+i.senderId+")")):null===t?(t=new B(e.settings),t.id=i.wcId,e.addWebChannel(t),t.join(n).then(function(){e.onWebChannel(t)})):0===t.members.length?(e.removeWebChannel(t),t=new B(e.settings),t.id=i.wcId,e.addWebChannel(t),t.join(n).then(function(){e.onWebChannel(t)})):console.error("Bot refused to join "+i.wcId+" webChannel, because it is already in use")}()}catch(e){n.close(pe,"Unsupported message type: "+e.message),console.error("Unsupported message type: "+e.message)}}})})}},{key:"stop",value:function(){var e=!0,n=!1,t=void 0;try{for(var i,r=this.webChannels[Symbol.iterator]();!(e=(i=r.next()).done);e=!0){var o=i.value;o.settings.listenOn=""}}catch(e){n=!0,t=e}finally{try{!e&&r.return&&r.return()}finally{if(n)throw t}}this.server.close()}},{key:"getWebChannel",value:function(e){var n=!0,t=!1,i=void 0;try{for(var r,o=this.webChannels[Symbol.iterator]();!(n=(r=o.next()).done);n=!0){var a=r.value;if(e===a.id)return a}}catch(e){t=!0,i=e}finally{try{!n&&o.return&&o.return()}finally{if(t)throw i}}return null}},{key:"addWebChannel",value:function(e){this.webChannels[this.webChannels.length]=e}},{key:"removeWebChannel",value:function(e){this.webChannels.splice(this.webChannels.indexOf(e),1)}}]),e}();e.create=n,e.BotServer=ye,e.WEB_SOCKET=ce,e.WEB_RTC=se,Object.defineProperty(e,"__esModule",{value:!0})});
