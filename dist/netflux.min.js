!function(e,n){"object"==typeof exports&&"object"==typeof module?module.exports=n():"function"==typeof define&&define.amd?define([],n):"object"==typeof exports?exports.nf=n():e.nf=n()}(this,function(){return function(e){function n(r){if(t[r])return t[r].exports;var o=t[r]={exports:{},id:r,loaded:!1};return e[r].call(o.exports,o,o.exports,n),o.loaded=!0,o.exports}var t={};return n.m=e,n.c=t,n.p="",n(0)}([function(e,n,t){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(n[t]=e[t]);return n["default"]=e,n}var i=t(1),a=o(i),s=t(10),c=r(s);e.exports.WEBRTC=a.WEBRTC,e.exports.FULLY_CONNECTED=a.FULLY_CONNECTED,e.exports.WebChannel=c["default"]},function(e,n,t){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e){var n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];if(y.has(e))return y.get(e);var t=void 0;switch(e){case f:return new c["default"](n);case h:return t=new a["default"],y.set(e,t),t;case d:return t=new l["default"],y.set(e,t),t}}Object.defineProperty(n,"__esModule",{value:!0}),n.FULLY_CONNECTED=n.WEBRTC=n.CHANNEL_PROXY=void 0,n.get=o;var i=t(2),a=r(i),s=t(6),c=r(s),u=t(8),l=r(u),d=n.CHANNEL_PROXY="ChannelProxyService",f=n.WEBRTC="WebRTCService",h=n.FULLY_CONNECTED="FullyConnectedService",y=new Map},function(e,n,t){"use strict";function r(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(n[t]=e[t]);return n["default"]=e,n}function o(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function i(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n}function a(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}Object.defineProperty(n,"__esModule",{value:!0});var s=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),c=t(3),u=r(c),l=function(e){function n(){return o(this,n),i(this,Object.getPrototypeOf(n).apply(this,arguments))}return a(n,e),s(n,[{key:"add",value:function(e){var n=e.webChannel,t=[n.myId];return n.channels.forEach(function(e){t[t.length]=e.peerId}),n.joiningPeers.forEach(function(n){e.peerId!==n.id&&(t[t.length]=n.id)}),this.connectWith(n,e.peerId,e.peerId,t)}},{key:"broadcast",value:function(e,n){var t=!0,r=!1,o=void 0;try{for(var i,a=e.channels[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var s=i.value;s.send(n)}}catch(c){r=!0,o=c}finally{try{!t&&a["return"]&&a["return"]()}finally{if(r)throw o}}}},{key:"sendTo",value:function(e,n,t){var r=!0,o=!1,i=void 0;try{for(var a,s=n.channels[Symbol.iterator]();!(r=(a=s.next()).done);r=!0){var c=a.value;c.peerId===e&&c.send(t)}}catch(u){o=!0,i=u}finally{try{!r&&s["return"]&&s["return"]()}finally{if(o)throw i}}}},{key:"leave",value:function(e){}}]),n}(u.Interface);n["default"]=l},function(e,n,t){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(n[t]=e[t]);return n["default"]=e,n}function i(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function a(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n}function s(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}Object.defineProperty(n,"__esModule",{value:!0}),n.Interface=n.ADD_INTERMEDIARY_CHANNEL=n.CONNECT_WITH_FEEDBACK=n.CONNECT_WITH=void 0;var c=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),u=t(4),l=o(u),d=t(5),f=r(d),h=t(1),y=o(h),p=n.CONNECT_WITH=1,v=n.CONNECT_WITH_FEEDBACK=2,g=n.ADD_INTERMEDIARY_CHANNEL=4,b=function(e){function n(){return i(this,n),a(this,Object.getPrototypeOf(n).apply(this,arguments))}return s(n,e),c(n,[{key:"onMessage",value:function(e,n){var t=this,r=y.get(e.settings.connector,e.settings);switch(n.code){case p:n.peers=this.reUseIntermediaryChannelIfPossible(e,n.jpId,n.peers),r.connectMeToMany(e,n.peers).then(function(r){r.forEach(function(t){e.initChannel(t,t.peerId),e.getJoiningPeer(n.jpId).toAddList(t),t.send(e.proxy.msg(l.THIS_CHANNEL_TO_JOINING_PEER,{id:n.jpId,toBeAdded:!0}))}),e.sendSrvMsg(t.name,n.sender,{code:v,id:e.myId,isDone:!0})})["catch"](function(r){e.sendSrvMsg(t.name,n.sender,{code:v,id:e.myId,isDone:!1})});break;case v:e.connectWithRequests.get(n.id)(n.isDone);break;case g:var o=e.getJoiningPeer(n.jpId);o.toAddList(o.intermediaryChannel)}}},{key:"connectWith",value:function(e,n,t,r){return e.sendSrvMsg(this.name,n,{code:p,jpId:t,sender:e.myId,peers:r}),new Promise(function(t,r){e.connectWithRequests.set(n,function(e){e?t():r()})})}},{key:"reUseIntermediaryChannelIfPossible",value:function(e,n,t){var r=null,o=void 0;return e.isJoining()?(o=e.getJoiningPeer(n),-1!==t.indexOf(o.intermediaryId)&&(r=o.intermediaryId)):-1!==t.indexOf(n)&&(o=e.getJoiningPeer(n),null!==o.intermediaryChannel&&(r=n)),null!==r&&(o.toAddList(o.intermediaryChannel),e.sendSrvMsg(this.name,r,{code:g,jpId:n}),t.splice(t.indexOf(r),1)),t}},{key:"broadcast",value:function(e,n){throw new Error("Must be implemented by subclass!")}},{key:"sendTo",value:function(e,n,t){throw new Error("Must be implemented by subclass!")}},{key:"leave",value:function(e){throw new Error("Must be implemented by subclass!")}},{key:"connectWithSuccess",value:function(e,n){throw new Error("Must be implemented by subclass!")}},{key:"connectWithFail",value:function(e,n){throw new Error("Must be implemented by subclass!")}}]),n}(f["default"]);n.Interface=b},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=t(1);Object.keys(r).forEach(function(e){"default"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return r[e]}})});n.USER_DATA=0,n.SERVICE_DATA=1,n.LEAVE=8,n.JOIN_INIT=3,n.JOIN_NEW_MEMBER=6,n.JOIN_FINILIZE=5,n.JOIN_SUCCESS=4,n.JOIN_STEP3_FAIL=2,n.THIS_CHANNEL_TO_JOINING_PEER=7},function(e,n){"use strict";function t(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),o=function(){function e(){t(this,e)}return r(e,[{key:"onMessage",value:function(e,n){throw new Error("Must be implemented by subclass!")}},{key:"name",get:function(){return this.constructor.name}}]),e}();n["default"]=o},function(e,n,t){"use strict";function r(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(n[t]=e[t]);return n["default"]=e,n}function o(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function i(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n}function a(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}Object.defineProperty(n,"__esModule",{value:!0});var s=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),c=t(7),u=r(c),l=2e3,d=function(e){function n(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];o(this,n);var t=i(this,Object.getPrototypeOf(n).call(this));return t.defaults={signaling:"ws://sigver-coastteam.rhcloud.com:8000",iceServers:[{urls:"stun:23.21.150.121"},{urls:"stun:stun.l.google.com:19302"},{urls:"turn:numb.viagenie.ca",credential:"webrtcdemo",username:"louis%40mozilla.com"}]},t.settings=Object.assign({},t.defaults,e),t.RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection||window.msRTCPeerConnection,t.RTCIceCandidate=window.RTCIceCandidate||window.mozRTCIceCandidate||window.RTCIceCandidate||window.msRTCIceCandidate,t.RTCSessionDescription=window.RTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription||window.msRTCSessionDescription,t}return a(n,e),s(n,[{key:"open",value:function(e,n){var t=this,r=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],o=e.id,i=Object.assign({},this.settings,r),a=[],s=new window.WebSocket(i.signaling);return s.onopen=function(){e.webRTCOpen=s,s.send(t.toStr({key:o}))},s.onmessage=function(e){var r=JSON.parse(e.data);if(!Reflect.has(r,"id")||!Reflect.has(r,"data"))throw new Error("Incorrect message format from the signaling server.");Reflect.has(r.data,"offer")?a[a.length]=t.createConnectionFromAnswer(function(e){return s.send(t.toStr({id:r.id,data:{candidate:e}}))},function(e){return s.send(t.toStr({id:r.id,data:{answer:e}}))},n,r.data.offer):Reflect.has(r.data,"candidate")&&a[r.id].addIceCandidate(t.createCandidate(r.data.candidate))},s.onerror=function(e){throw new Error("Connection to the signaling server "+i.signaling+" failed: "+e.message+".")},s.onclose=function(){delete e.webRTCOpen},{key:o,signaling:i.signaling}}},{key:"join",value:function(e){var n=this,t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],r=Object.assign({},this.settings,t);return new Promise(function(t,o){var i=void 0,a=new window.WebSocket(r.signaling);a.onopen=function(){i=n.createConnectionFromOffer(function(e){return a.send(n.toStr({data:{candidate:e}}))},function(t){return a.send(n.toStr({join:e,data:{offer:t}}))},function(e){return t(e)},e)},a.onmessage=function(e){var t=JSON.parse(e.data);if(Reflect.has(t,"data")||o(),Reflect.has(t.data,"answer")){var r=n.createSDP(t.data.answer);i.setRemoteDescription(r,function(){},o)}else Reflect.has(t.data,"candidate")?i.addIceCandidate(n.createCandidate(t.data.candidate)):o()},a.onerror=o})}},{key:"connectMeToMany",value:function(e,n){var t=[],r=!0,o=!1,i=void 0;try{for(var a,s=n[Symbol.iterator]();!(r=(a=s.next()).done);r=!0){var c=a.value;t.push(this.connectMeToOne(e,c))}}catch(u){o=!0,i=u}finally{try{!r&&s["return"]&&s["return"]()}finally{if(o)throw i}}return Promise.all(t)}},{key:"connectMeToOne",value:function(e,n){var t=this;return new Promise(function(r,o){var i=e.myId,a=t.createConnectionFromOffer(function(r){return e.sendSrvMsg(t.name,n,{sender:i,candidate:r})},function(r){e.connections.set(n,a),e.sendSrvMsg(t.name,n,{sender:i,offer:r})},function(e){e.peerId=n,r(e)},n);setTimeout(o,l,"Timeout")})}},{key:"onMessage",value:function(e,n){var t=this,r=e.connections;if(Reflect.has(n,"offer"))r.set(n.sender,this.createConnectionFromAnswer(function(r){return e.sendSrvMsg(t.name,n.sender,{sender:e.myId,candidate:r})},function(r){return e.sendSrvMsg(t.name,n.sender,{sender:e.myId,answer:r})},function(t){e.initChannel(t,n.sender),e.connections["delete"](t.peerId)},n.offer));else{var o=r.get(n.sender);if(Reflect.has(n,"answer")){var i=this.createSDP(n.answer);o.setRemoteDescription(i,function(){},function(){})}else Reflect.has(n,"candidate")&&o.addIceCandidate(this.createCandidate(n.candidate))}}},{key:"createConnectionFromOffer",value:function(e,n,t,r){var o=this.initConnection(e),i=o.createDataChannel(r);return i.onopen=function(){return t(i)},o.createOffer(function(e){o.setLocalDescription(e,function(){n(o.localDescription.toJSON())},function(e){throw new Error("Could not set local description: "+e)})},function(e){throw new Error("Could not create offer: "+e)}),o}},{key:"createConnectionFromAnswer",value:function(e,n,t,r){var o=this.initConnection(e);return o.ondatachannel=function(e){e.channel.onopen=function(){return t(e.channel)}},o.setRemoteDescription(this.createSDP(r),function(){o.createAnswer(function(e){o.setLocalDescription(e,function(){n(o.localDescription.toJSON())},function(e){throw new Error("Could not set local description: "+e)})},function(e){throw new Error("Could not create answer: "+e)})},function(e){throw new Error("Could not set remote description: "+e)}),o}},{key:"initConnection",value:function(e){var n=new this.RTCPeerConnection({iceServers:this.settings.iceServers});return n.onicecandidate=function(n){if(null!==n.candidate){var t={candidate:n.candidate.candidate,sdpMLineIndex:n.candidate.sdpMLineIndex};e(t)}},n}},{key:"createCandidate",value:function(e){return new this.RTCIceCandidate(e)}},{key:"createSDP",value:function(e){return Object.assign(new this.RTCSessionDescription,e)}},{key:"randomKey",value:function(){for(var e=10,n=10,t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",r="",o=e+Math.round(Math.random()*n),i=0;o>i;i++)r+=t[Math.round(Math.random()*(t.length-1))];return r}},{key:"toStr",value:function(e){return JSON.stringify(e)}}]),n}(u.Interface);n["default"]=d},function(e,n,t){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function i(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n}function a(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}Object.defineProperty(n,"__esModule",{value:!0}),n.Interface=void 0;var s=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),c=t(5),u=r(c),l=function(e){function n(){return o(this,n),i(this,Object.getPrototypeOf(n).apply(this,arguments))}return a(n,e),s(n,[{key:"connectMeToMany",value:function(e,n){throw new Error("Must be implemented by subclass!")}},{key:"connectMeToOne",value:function(e,n){throw new Error("Must be implemented by subclass!")}},{key:"open",value:function(e){arguments.length<=1||void 0===arguments[1]?{}:arguments[1];throw new Error("Must be implemented by subclass!")}},{key:"join",value:function(e){arguments.length<=1||void 0===arguments[1]?{}:arguments[1];throw new Error("Must be implemented by subclass!")}}]),n}(u["default"]);n.Interface=l},function(e,n,t){"use strict";function r(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(n[t]=e[t]);return n["default"]=e,n}function o(e){return e&&e.__esModule?e:{"default":e}}function i(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function a(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n}function s(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}Object.defineProperty(n,"__esModule",{value:!0});var c=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),u=t(5),l=o(u),d=t(4),f=r(d),h=t(9),y=o(h),p=t(1),v=r(p),g=function(e){function n(){return i(this,n),a(this,Object.getPrototypeOf(n).apply(this,arguments))}return s(n,e),c(n,[{key:"onMsg",value:function(e){var n=JSON.parse(e.data),t=e.currentTarget,r=t.webChannel,o=void 0;switch(n.code){case f.USER_DATA:r.onMessage(n.id,n.data);break;case f.LEAVE:r.onLeaving(n.id),r.channels["delete"](r.channels.get(n.id));break;case f.SERVICE_DATA:r.myId===n.recepient?r.proxy.onSrvMsg(r,n):r.sendSrvMsg(n.serviceName,n.recepient,n.data);break;case f.JOIN_INIT:r.initManager(n.manager),r.myId=n.id,t.peerId=n.intermediaryId,o=new y["default"](n.id,n.intermediaryId),o.intermediaryChannel=t,r.addJoiningPeer(o);break;case f.JOIN_NEW_MEMBER:r.addJoiningPeer(new y["default"](n.id,n.intermediaryId));break;case f.JOIN_FINILIZE:r.joinSuccess(r.myId);var i=r.proxy.msg(f.JOIN_SUCCESS,{id:r.myId});r.manager.broadcast(r,i),r.onJoin();break;case f.JOIN_SUCCESS:r.joinSuccess(n.id),r.onJoining(n.id);break;case f.THIS_CHANNEL_TO_JOINING_PEER:r.hasJoiningPeer(n.id)?o=r.getJoiningPeer(n.id):(o=new y["default"](n.id),r.addJoiningPeer(o)),n.toBeAdded?o.toAddList(t):o.toRemoveList(t)}}},{key:"onSrvMsg",value:function(e,n){v.get(n.serviceName,e.settings).onMessage(e,n.data)}},{key:"msg",value:function t(e){var n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],t=Object.assign({code:e},n);return JSON.stringify(t)}}]),n}(l["default"]);n["default"]=g},function(e,n){"use strict";function t(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),o=function(){function e(n,r){t(this,e),this.id=n,this.intermediaryId=r,this.intermediaryChannel=null,this.channelsToAdd=[],this.channelsToRemove=[]}return r(e,[{key:"toAddList",value:function(e){this.channelsToAdd[this.channelsToAdd.length]=e}},{key:"toRemoveList",value:function(e){this.channelsToAdd[this.channelsToAdd.length]=e}}]),e}();n["default"]=o},function(e,n,t){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(n[t]=e[t]);return n["default"]=e,n}function i(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var a=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),s=t(4),c=o(s),u=t(1),l=o(u),d=t(9),f=r(d),h=function(){function e(){var n=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];i(this,e),this.defaults={connector:l.WEBRTC,topology:l.FULLY_CONNECTED},this.settings=Object.assign({},this.defaults,n),this.id=this.generateId(),this.myId=this.generateId(),this.channels=new Set,this.onJoin,this.joiningPeers=new Set,this.connectWithRequests=new Map,this.connections=new Map,this.proxy=l.get(l.CHANNEL_PROXY),this.manager=null}return a(e,[{key:"onJoining",value:function(e){}},{key:"onLeaving",value:function(e){}},{key:"leave",value:function(){this.manager.broadcast(this,this.proxy.msg(c.LEAVE,{id:this.myId}))}},{key:"send",value:function(e){this.manager.broadcast(this,this.proxy.msg(c.USER_DATA,{id:this.myId,data:e}))}},{key:"openForJoining",value:function(){var e=this,n=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],t=Object.assign({},this.settings,n),r=l.get(t.connector,t),o=r.open(this,function(n){e.initManager(),e.initChannel(n);var t=new f["default"](n.peerId,e.myId);t.intermediaryChannel=n,e.joiningPeers.add(t),n.send(e.proxy.msg(c.JOIN_INIT,{manager:e.settings.topology,id:n.peerId,intermediaryId:e.myId})),e.manager.broadcast(e,e.proxy.msg(c.JOIN_NEW_MEMBER,{id:n.peerId,intermediaryId:e.myId})),e.manager.add(n).then(function(){n.send(e.proxy.msg(c.JOIN_FINILIZE))})["catch"](function(){})});return o.key}},{key:"closeForJoining",value:function(){Reflect.has(this,"webRTCOpen")&&this.webRTCOpen.close()}},{key:"join",value:function(e){var n=this,t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],r=Object.assign({},this.settings,t),o=l.get(r.connector,r);return new Promise(function(t,r){o.join(e).then(function(e){n.initChannel(e),n.onJoin=function(){t(n)}})})}},{key:"isInviting",value:function(){}},{key:"has",value:function(e){var n=!0,t=!1,r=void 0;try{for(var o,i=this.channels[Symbol.iterator]();!(n=(o=i.next()).done);n=!0){var a=o.value;if(a.peerId===e)return!0}}catch(s){t=!0,r=s}finally{try{!n&&i["return"]&&i["return"]()}finally{if(t)throw r}}return!1}},{key:"sendSrvMsg",value:function(e,n){var t=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],r={serviceName:e,recepient:n,data:Object.assign({},t)},o=this.proxy.msg(c.SERVICE_DATA,r);if(n===this.myId)this.proxy.onSrvMsg(this,r);else if(this.isJoining())this.getJoiningPeer(this.myId).intermediaryChannel.send(o);else if(this.hasJoiningPeer(n)){var i=this.getJoiningPeer(n);i.intermediaryId===this.myId?i.intermediaryChannel.send(o):this.manager.sendTo(i.intermediaryId,this,o)}else this.manager.sendTo(n,this,o)}},{key:"initChannel",value:function(e){var n=arguments.length<=1||void 0===arguments[1]?"":arguments[1];e.webChannel=this,e.onmessage=this.proxy.onMsg,""!==n?e.peerId=n:e.peerId=this.generateId()}},{key:"initManager",value:function(){var e=arguments.length<=0||void 0===arguments[0]?"":arguments[0];if(null!==this.manager){if(this.topology===this.manager.constructor.name)return;throw new Error("Manager for this WebChannel has already been initialized and thus cannot be changed!")}""!==e&&(this.topology=e),this.manager=l.get(this.settings.topology)}},{key:"joinSuccess",value:function(e){var n=this,t=this.getJoiningPeer(e);t.channelsToAdd.forEach(function(e){n.channels.add(e),n.joiningPeers["delete"](t)})}},{key:"getJoiningPeer",value:function(e){var n=!0,t=!1,r=void 0;try{for(var o,i=this.joiningPeers[Symbol.iterator]();!(n=(o=i.next()).done);n=!0){var a=o.value;if(a.id===e)return a}}catch(s){t=!0,r=s}finally{try{!n&&i["return"]&&i["return"]()}finally{if(t)throw r}}throw new Error("Joining peer not found!")}},{key:"addJoiningPeer",value:function(e){if(this.hasJoiningPeer(e.id))throw new Error("Joining peer already exists!");this.joiningPeers.add(e)}},{key:"isJoining",value:function(){var e=!0,n=!1,t=void 0;try{for(var r,o=this.joiningPeers[Symbol.iterator]();!(e=(r=o.next()).done);e=!0){var i=r.value;if(i.id===this.myId)return!0}}catch(a){n=!0,t=a}finally{try{!e&&o["return"]&&o["return"]()}finally{if(n)throw t}}return!1}},{key:"hasJoiningPeer",value:function(e){var n=!0,t=!1,r=void 0;try{for(var o,i=this.joiningPeers[Symbol.iterator]();!(n=(o=i.next()).done);n=!0){var a=o.value;if(a.id===e)return!0}}catch(s){t=!0,r=s}finally{try{!n&&i["return"]&&i["return"]()}finally{if(t)throw r}}return!1}},{key:"generateId",value:function(){for(var e=2,n=0,t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",r="",o=e+Math.round(Math.random()*n),i=0;o>i;i++)r+=t[Math.round(Math.random()*(t.length-1))];return r}},{key:"topology",set:function(e){this.settings.topology=e},get:function(){return this.settings.topology}}]),e}();n["default"]=h}])});